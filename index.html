<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dasbor Kehadiran Karyawan â€¢ SmartAttend</title>

  <!-- GUARD: blokir akses bila belum login -->
  <script>
    (function(){
      try{
        const a = JSON.parse(localStorage.getItem('SA_AUTH') || 'null');
        if(!(a && a.expiresAt && a.expiresAt > Date.now())) {
          location.replace('login.html');
        }
      }catch{
        location.replace('login.html');
      }
    })();
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- NEW: jsPDF untuk cetak ID Card -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Supabase config + init (PUBLIC anon keyâ€”pastikan RLS aman) -->
  <script>
    window.SUPABASE_URL = "https://eiomyewcihrqzlslplen.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpb215ZXdjaWhycXpsc2xwbGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxNTIxNjQsImV4cCI6MjA3NzcyODE2NH0.uZJpktYvGUDGjBeK4Ou54Tw9TAQsfrmehYc5Apxi6CE";
  </script>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    window.supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    console.info("[SmartAttend] Supabase siap:", window.SUPABASE_URL);

    // Watcher: auto-redirect jika sesi Supabase hilang/expired
    const goLogin = () => {
      if (!location.pathname.endsWith('/login.html')) location.replace('login.html');
    };

    window.supabase.auth.getSession().then(({ data }) => {
      if (!data?.session) goLogin();
    });
    window.supabase.auth.onAuthStateChange((_e, session) => {
      if (!session) goLogin();
    });
  </script>

  <!-- Helper style kecil (tidak bentrok) -->
  <style>
    #empModal .modal{position:relative}
    #empModal .modal-close{position:absolute;right:10px;top:8px;border:0;background:transparent;font-size:24px;line-height:1;cursor:pointer}
    .camera-actions{display:flex;gap:10px;align-items:center}
    .hidden{display:none}
    .company-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
    .company-card{background:var(--panel,#fff);border:1px solid #e5e7eb;border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .company-card .name{font-weight:600}
    .company-card .sub{color:#64748b;font-size:12px;margin-top:2px}
    .company-card .badge{font-weight:800;font-size:22px}
    #tableShiftTime input[type="time"]{width:140px;max-width:100%}
    @media (max-width:1100px){ #route-scan .scan-stats-grid{grid-template-columns:1fr} }

    /* === EDUCATION UI (dasar) === */
    .img-preview{display:flex;align-items:center;gap:10px;margin-top:6px}
    .img-preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb}
    .edu-thumb{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer}

    #eduHighlightsCard .card-title{display:flex;align-items:center;gap:8px}
    .edu-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .edu-item{
      background:var(--surface,#fff);
      border:1px solid var(--line,#e6eefc);
      border-radius:16px;
      padding:12px;
      box-shadow:0 4px 14px rgba(0,0,0,.05);
      display:grid;grid-template-columns:72px 1fr;gap:12px
    }
    .edu-item .thumb{width:72px;height:72px;border-radius:12px;object-fit:cover;border:1px solid var(--line,#e6eefc);background:#f3f4f6}
    .edu-item .t{font-weight:700;line-height:1.25;margin-bottom:2px}
    .edu-item .d{
      color:#64748b;font-size:13px;line-height:1.35;
      display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;
      line-clamp: 2; overflow:hidden;
    }
    .edu-item .meta{color:#94a3b8;font-size:12px;margin-top:6px}
    .edu-bar{position:relative;margin-top:10px;height:14px;border-radius:999px;background:var(--line,#e6eefc);overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,.05)}
    .edu-bar i{display:block;height:100%;width:var(--pct,60%);border-radius:inherit;background:linear-gradient(90deg,var(--primary-500,#4a8cff),var(--primary-300,#a6c8ff))}
    .edu-bar .val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#0b2545}

    /* ===== BRAND CORNER ===== */
    :root{ --brand-size:150px; --brand-gap:12px; }
    #route-dashboard, #route-scan{ position:relative; }
    .brand-corner{
      --panel-alpha: .55;
      position:absolute; top:12px; left:12px;
      width:var(--brand-size); height:var(--brand-size);
      display:grid; place-items:center; padding:10px;
      background:rgba(255,255,255,var(--panel-alpha));
      border:1px solid var(--line); border-radius:16px;
      box-shadow:var(--shadow); z-index:4; backdrop-filter: blur(6px);
    }
    .brand-corner img{ max-width:100%; max-height:100%; object-fit:contain; display:block; }
    #route-dashboard .greet{ margin-left:calc(var(--brand-size) + var(--brand-gap)); }
    #route-scan .scan-hero-left{ margin-left:calc(var(--brand-size) + var(--brand-gap)); }
    @media (max-width:1100px){ .brand-corner{ --brand-size:76px; top:10px; left:10px; } #route-dashboard .greet, #route-scan .scan-hero-left{ margin-left:0; } }
    #route-dashboard:fullscreen .brand-corner,
    #route-dashboard:-webkit-full-screen .brand-corner,
    #route-scan:fullscreen .brand-corner,
    #route-scan:-webkit-full-screen .brand-corner{ position:absolute; top:12px; left:12px; }

    /* =========================
       PATCH: LOCK SIZE + HIDE % LABEL
       ========================= */
    .edu-bar .val{ display:none !important; }  /* sembunyikan label % */
    #brandLogoPanelDash.brand-corner, #brandLogoPanelScan.brand-corner{
      inline-size: var(--brand-size) !important; block-size: var(--brand-size) !important;
      min-inline-size: var(--brand-size) !important; min-block-size: var(--brand-size) !important;
      aspect-ratio: 1 / 1; border-radius: 50% !important; flex: 0 0 auto !important;
    }
    #brandLogoPanelDash.brand-corner img, #brandLogoPanelScan.brand-corner img{
      inline-size:100% !important; block-size:100% !important; object-fit:contain !important;
    }

    /* ====== Layout gabungan: Recent + Education ====== */
    #recentCard .subhead{font-weight:700;margin:0 0 8px;color:var(--text)}
    #recentCard .recent-flex{
      display:grid; grid-template-columns:minmax(260px,0.95fr) 1.05fr;
      gap:12px; align-items:start; min-height:0;
    }
    #recentCard .recent-edu{display:flex;flex-direction:column;min-height:0}
    #recentCard .recent-table{min-width:0}
    #recentCard .edu-list.compact{grid-template-columns:1fr}
    #recentCard .edu-list.compact .edu-item{grid-template-columns:56px 1fr;gap:10px;padding:10px;border-radius:12px}
    #recentCard .edu-list.compact .thumb{width:56px;height:56px;border-radius:10px}
    #recentCard[data-has-edu="0"] .recent-edu{display:none}
    #recentCard[data-has-edu="0"] .recent-table{grid-column:1 / -1}
    @media (max-width:1100px){ #recentCard .recent-flex{grid-template-columns:1fr} #recentCard .recent-edu{order:2} }

    /* Animasi halus Education */
    .edu-item{ position:relative; will-change:transform, box-shadow; animation:eduPulse 3.4s ease-in-out infinite; }
    .edu-item::after{ content:""; position:absolute; inset:-20% -10% auto -10%; height:60%;
      background:radial-gradient(60% 50% at 20% 0%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%);
      pointer-events:none; animation:eduGlow 3.4s ease-in-out infinite; }
    .edu-item::before{ content:""; position:absolute; inset:0;
      background:linear-gradient(130deg,transparent 5%, rgba(255,255,255,.55) 50%, transparent 95%);
      mix-blend-mode:screen; transform:translateX(-130%); animation:eduSweep 6s linear infinite; pointer-events:none; }
    .edu-item .thumb{ animation:eduPing 2.6s ease-in-out infinite; transform-origin:center; }
    .edu-bar i{ position:relative; }
    .edu-bar i::after{ content:""; position:absolute; inset:0; transform:translateX(-120%);
      background:linear-gradient(120deg, transparent 0%, rgba(255,255,255,.65) 50%, transparent 100%);
      animation:eduBarShine 2.6s linear infinite; }
    @keyframes eduPulse{ 0%,100%{ box-shadow:0 8px 18px rgba(2,6,23,.08); transform:translateY(0) } 50%{ box-shadow:0 14px 28px rgba(2,6,23,.16); transform:translateY(-2px) } }
    @keyframes eduGlow{ 0%,100%{ opacity:.18; transform:translateY(0) } 50%{ opacity:.34; transform:translateY(-4px) } }
    @keyframes eduSweep{ 0%{ transform:translateX(-130%) } 100%{ transform:translateX(130%) } }
    @keyframes eduPing{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.04) } }
    @keyframes eduBarShine{ 0%{ transform:translateX(-120%) } 100%{ transform:translateX(120%) } }
    @media (prefers-reduced-motion:reduce){
      .edu-item, .edu-item::before, .edu-item::after, .edu-item .thumb, .edu-bar i::after{ animation:none !important; }
    }

    /* =========================
       TAMBAHAN: BRAND SIDEBAR + LOGOUT
       ========================= */
    .sidebar{ display:flex; flex-direction:column; min-height:100dvh; }
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:14px 16px; text-decoration:none; color:var(--text,#0b2540);
    }
    .brand-logo{ width:34px; height:34px; object-fit:contain; display:block; }
    .brand-name{ font-weight:800; font-size:18px; letter-spacing:.2px; }
    .brand-sub{ font-size:12px; color:#64748b; margin-top:2px; }

    .sidebar-footer{ margin-top:auto; padding:12px 14px 16px; display:grid; gap:8px; }
    .logout-btn{
      width:100%; display:flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 14px; border-radius: var(--radius, 16px);
      border:1px solid color-mix(in srgb, var(--surface, #fff), #000 7%);
      background: color-mix(in srgb, var(--surface, #fff), #000 3%);
      color: var(--text, #0b2540); font-weight:700; cursor:pointer;
      transition: transform .06s ease, background .2s ease, box-shadow .2s ease;
    }
    .logout-btn:hover{
      background: color-mix(in srgb, var(--surface, #fff), #000 7%);
      box-shadow: 0 6px 18px rgba(0,0,0,.08) inset;
    }
    .logout-btn:active{ transform: translateY(1px) }
    @media (prefers-reduced-motion: reduce){ .logout-btn{ transition:none } }

    /* Tambahan: progress bar untuk tabel statistik kehadiran realtime */
    .table.light .presence .presence-bar{
      height:10px; border-radius:999px; background:#e6eefc; overflow:hidden;
    }
    .table.light .presence .presence-bar i{
      display:block; height:100%; width:0;
      background:linear-gradient(90deg,var(--primary-500,#4a8cff),var(--primary-300,#a6c8ff));
    }

    /* ====== Dev reset button style (added) ====== */
    #dev-reset-local {
      position: fixed;
      right: 16px;
      bottom: 18px;
      z-index: 99999;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: #ef4444;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 8px 26px rgba(0,0,0,0.18);
      cursor: pointer;
    }
    @media (max-width:520px){ #dev-reset-local{ right:12px; bottom:12px; padding:8px 10px } }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-brand">SmartAttend</div>
    <button id="btnToggleMenu" class="btn-menu">â˜°</button>
  </header>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <!-- GUNAKAN LOGO YANG SAMA DENGAN BRAND-CORNER -->
      <img class="brand-logo"
           src="assets/LOGO PLN NP SERVICES - FIN.png"
           alt="PLN Nusantara Power Services"
           onerror="this.onerror=null; this.src='assets/LOGO PLN NP SERVICES - FIN.svg';">
      <div>
        <div class="brand-name">SmartAttend</div>
        <div class="brand-sub">PLTU AMPANA</div>
      </div>
    </div>

    <nav class="nav">
      <button class="navlink active" data-route="dashboard">ğŸ“Š Dasbor</button>
      <button class="navlink" data-route="scan">ğŸ” Scan Barcode</button>
      <button class="navlink" data-route="employees">ğŸ‘¥ Database Karyawan</button>
      <button class="navlink" data-route="shifts">ğŸ•˜ Pengaturan Shift</button>
      <button class="navlink" data-route="attendance">ğŸ“‘ Laporan 24 Jam</button>
      <button class="navlink" data-route="latest">ğŸ“° Latest information</button>
      <button class="navlink" data-route="education">ğŸ“ Education</button>
    </nav>

    <!-- FOOTER + LOGOUT -->
    <div class="sidebar-footer">
      <button id="btnLogout" class="logout-btn" type="button" aria-label="Logout dari SmartAttend">ğŸšª Logout</button>
      <small class="muted">v1.4 â€¢ Local-first</small>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- DASHBOARD -->
    <section class="route" id="route-dashboard">
      <!-- LOGO PANEL (dashboard) -->
      <div id="brandLogoPanelDash" class="brand-corner card subtle">
        <img src="assets/LOGO PLN NP SERVICES - FIN.png"
             alt="PLN Nusantara Power Services"
             onerror="this.onerror=null; this.src='assets/LOGO PLN NP SERVICES - FIN.svg';">
      </div>

      <div class="greet card">
        <div>
          <h1>SELAMAT DATANG DI PT PLN NUSANTARA POWER SERVICES LINGKUP PLTU AMPANA âš¡</h1>
          <p>ANDA BERADA DI KAWASAN PLN NPS UNIT PLTU AMPANA DAN WAJIB MEMATUHI SEMUA ATURAN YANG BERLAKU</p>
        </div>
        <div style="display:flex; align-items:center; gap:12px">
          <div class="clock" id="liveClock">--:--</div>
          <button id="btnFullDash" class="btn light">â›¶ Layar Penuh</button>
        </div>
      </div>

      <!-- Kartu statistik -->
      <div class="grid-3">
        <div class="card stat">
          <div class="stat-label">Total Karyawan</div>
          <div class="stat-value" id="statTotalEmp">0</div>
          <div class="stat-sub"><span id="statShiftBreakdown">â€”</span></div>
        </div>

        <div class="card stat">
          <div class="stat-label">Scan 24 jam</div>
          <div class="stat-value" id="statScan24h">0</div>
          <div class="stat-sub">Datang: <b id="statIn24h">0</b> â€¢ Pulang: <b id="statOut24h">0</b></div>
        </div>

        <div class="card stat">
          <div class="stat-label">On-time vs Terlambat (hari ini)</div>
          <div class="progress-bar"><div id="onTimeBar" class="progress"></div></div>
          <div class="stat-sub">On-time: <b id="statOnTime">0</b> â€¢ Terlambat: <b id="statLate">0</b></div>
        </div>
      </div>

      <!-- Company Presence -->
      <div class="card" id="companyPresenceCard">
        <div class="card-title">Company Attendance (today)</div>
        <div class="live-row" style="margin:2px 0 10px">
          <b>Statistik Kehadiran Langsung</b>
          <span class="muted" id="companyLiveTime">--:--:--</span>
        </div>
        <div id="companyPresenceGrid" class="company-grid"></div>
      </div>

      <!-- ===== DASH TRIO ===== -->
      <div class="dash-trio">
        <div class="card" id="monthCalendarCard">
          <div class="card-title">Kalender Bulan Ini</div>
          <div id="monthCalendar"></div>
        </div>

        <div class="card" id="newsCardDash">
          <div class="card-title">Informasi Terbaruâš ï¸ğŸ“¢</div>
          <div class="news-grid" id="newsGridDash"></div>
        </div>

        <!-- GABUNG: Aktivitas Terbaru + Education (fleksibel) -->
        <div class="card" id="recentCard" data-has-edu="0">
          <div class="recent-flex">
            <!-- Education (Highlights) -->
            <aside class="recent-edu" id="recentEduPane">
              <div class="subhead">Education (Highlights)</div>
              <div id="eduListRecent" class="edu-list compact"></div>
            </aside>

            <!-- Tabel Aktivitas -->
            <div class="recent-table">
              <div class="subhead">Aktivitas Terbaru <small id="recentCount" class="muted">(3 terakhir hari ini)</small></div>
              <div class="table-wrap">
                <table class="table" id="tableRecent">
                  <thead><tr><th>Waktu</th><th>Status</th><th>NID</th><th>Nama</th><th>Shift</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- /GABUNG -->
      </div>
    </section>

    <!-- SCAN -->
    <section class="route hidden" id="route-scan">
      <!-- LOGO PANEL (scan) -->
      <div id="brandLogoPanelScan" class="brand-corner card subtle">
        <img src="assets/LOGO PLN NP SERVICES - FIN.png"
             alt="PLN Nusantara Power Services"
             onerror="this.onerror=null; this.src='assets/LOGO PLN NP SERVICES - FIN.svg';">
      </div>

      <div class="scan-ui">
        <div class="scan-hero">
          <!-- Kiri -->
          <div class="scan-hero-left">
            <div class="scan-hello"></div>
            <div class="scan-title-actions">
              <h2 class="scan-title">SELAMAT DATANG DI PT PLN NUSANTARA POWER SERVICES LINGKUP PLTU AMPANA âš¡</h2>
              <button id="btnFull" class="btn light">â›¶ Layar Penuh</button>
            </div>
            <input id="scanInput" class="scan-input light" placeholder="Klik di sini lalu scanâ€¦" autocomplete="off" autocapitalize="off" spellcheck="false" inputmode="none"/>
            <div class="hint light">Utamakan Keselamatan dan Kesehatan Kerja.</div>

            <!-- STATISTIK KEHADIRAN (REALTIME) -->
            <div id="scan-stats" class="scan-stats">
              <div class="scan-stats-head">
                <b>Statistik Kehadiran (Realtime)</b>
                <span class="muted" id="scan-stats-time">--:--:--</span>
              </div>
              <div class="scan-stats-grid">
                <div class="chart-col">
                  <canvas id="presencePie" aria-label="Pie Kehadiran per Perusahaan" role="img"></canvas>
                </div>
                <div class="table-wrap light">
                  <table class="table light presence" id="presenceTable">
                    <thead>
                      <tr><th>Perusahaan</th><th>Hadir</th><th>%</th><th>Progress</th></tr>
                    </thead>
                    <tbody id="presenceTBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
            <!-- /STATISTIK -->
          </div>

          <!-- Kanan -->
          <div class="scan-hero-right" id="scanResult">
            <div class="photo-big" id="scanPhoto"></div>
            <div class="info">
              <div class="name" id="scanName">â€”</div>
              <div class="meta"><span id="scanNID">â€”</span> <span id="scanTitle">â€”</span></div>
              <div class="meta"><span id="scanCompany">â€”</span> <span id="scanShift">â€”</span></div>
              <div class="pill light" id="scanShiftCheck">â€”</div>
              <div class="ts" id="scanTs">â€”</div>
            </div>
          </div>
        </div>

        <!-- Info terbaru (kiri bawah) -->
        <div class="card-light" style="margin-top:12px">
          <div class="card-title-light">Informasi Terbaru âš ï¸ğŸ“¢</div>
          <div class="news-grid" id="newsGridScan"></div>
        </div>

        <!-- Tabel 5 scan terbaru hari ini -->
        <div class="scan-table card-light">
          <div class="card-title-light">Riwayat Scan (5 terbaru hari ini)</div>
          <div class="table-wrap light">
            <table class="table light" id="tableScan">
              <thead>
                <tr>
                  <th>Waktu</th><th>Status</th><th>NID</th><th>Nama</th><th>Jabatan</th><th>Perusahaan</th><th>Shift</th><th>Keterangan</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- EMPLOYEES -->
    <section class="route hidden" id="route-employees">
      <div class="toolbar">
        <div class="left">
          <button id="btnAddEmp" class="btn primary">ï¼‹ Tambah</button>
          <input type="file" id="fileImportEmp" accept=".xlsx,.xls" hidden>
          <button id="btnImportEmp" class="btn">â¬†ï¸ Import Excel</button>
          <button id="btnExportEmp" class="btn ghost">â¬‡ï¸ Export Excel</button>
          <button id="btnTemplateEmp" class="btn ghost">ğŸ“„ Unduh Template</button>
        </div>
        <div class="right"><input id="searchEmp" class="search" placeholder="Cari nama atau NIDâ€¦"/></div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="table" id="tableEmp">
            <thead><tr><th>Foto</th><th>NID</th><th>Nama</th><th>Jabatan</th><th>Perusahaan</th><th>Shift</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SHIFTS -->
    <section class="route hidden" id="route-shifts">
      <div class="card">
        <div class="card-title">Pengaturan Jam Shift</div>
        <div class="table-wrap">
          <table class="table" id="tableShiftTime">
            <thead><tr><th style="width:220px">Kode</th><th>Datang</th><th>Pulang</th><th style="width:120px">Aksi</th></tr></thead>
            <tbody>
              <tr>
                <td><select disabled><option>Pagi (P)</option></select></td>
                <td><input type="time" id="shiftPagiStart" value="08:00"></td>
                <td><input type="time" id="shiftPagiEnd"   value="16:00"></td>
                <td></td>
              </tr>
              <tr>
                <td><select disabled><option>Sore (S)</option></select></td>
                <td><input type="time" id="shiftSoreStart" value="16:00"></td>
                <td><input type="time" id="shiftSoreEnd"   value="24:00"></td>
                <td></td>
              </tr>
              <tr>
                <td><select disabled><option>Malam (M)</option></select></td>
                <td><input type="time" id="shiftMalamStart" value="24:00"></td>
                <td><input type="time" id="shiftMalamEnd"   value="07:00"></td>
                <td></td>
              </tr>
              <tr>
                <td><select disabled><option>Day Time (DAY)</option></select></td>
                <td><input type="time" id="shiftDayStart" value="08:00"></td>
                <td><input type="time" id="shiftDayEnd"   value="16:00"></td>
                <td></td>
              </tr>
              <tr>
                <td><select disabled><option>Libur (L)</option></select></td>
                <td><input type="time" disabled></td>
                <td><input type="time" disabled></td>
                <td><button class="btn ghost" disabled>Hapus</button></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="toolbar">
          <button id="btnSaveShift" class="btn primary">ğŸ’¾ Simpan Pengaturan</button>
          <span class="muted">Gunakan <b>24:00</b> untuk akhir hari. Sistem otomatis menangani lintas tengah malam.</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Jadwal Shift Bulanan</div>
        <div class="toolbar" style="margin-bottom:8px">
          <div class="left" style="gap:10px; flex-wrap:wrap">
            <label>Bulan <input type="month" id="schedMonth"></label>
            <button class="btn" id="btnSchedDownload">ğŸ“„ Download Template</button>
            <input type="file" id="fileImportSched" accept=".xlsx,.xls" hidden>
            <button class="btn" id="btnSchedImport">â¬†ï¸ Import Template</button>
          </div>
          <div class="right" style="gap:8px; display:flex">
            <button class="btn primary" id="btnSchedSave">ğŸ’¾ Simpan Jadwal</button>
            <button class="btn ghost" id="btnSchedReset">ğŸ§¹ Reset Bulan</button>
          </div>
        </div>
        <div class="table-wrap"><table class="table" id="tableSched"></table></div>
        <small class="muted">Tips: pilih nama pada setiap sel. Data tersimpan per-bulan di perangkat ini.</small>
      </div>
    </section>

    <!-- ATTENDANCE -->
    <section class="route hidden" id="route-attendance">
      <div class="toolbar">
        <div class="left">
          <label>Dari <input type="date" id="attFrom"></label>
          <label>Sampai <input type="date" id="attTo"></label>
          <button id="btnFilterAtt" class="btn">ğŸ” Tampilkan</button>
          <button id="btnExportAtt" class="btn ghost">â¬‡ï¸ Export Excel</button>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="table" id="tableAtt">
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Status</th>
                <th>NID</th>
                <th>Nama</th>
                <th>Jabatan</th>
                <th>Perusahaan</th>
                <th>Shift</th>
                <th>Keterangan</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- LATEST -->
    <section class="route hidden" id="route-latest">
      <div class="toolbar">
        <div class="left"><button id="btnAddNews" class="btn primary">ï¼‹ Tambah Info</button></div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="tableNews">
            <thead><tr><th>Waktu</th><th>Judul</th><th>Detail</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BARU: EDUCATION -->
    <section class="route hidden" id="route-education">
      <div class="toolbar">
        <div class="left">
          <button id="btnAddEdu" class="btn primary">ï¼‹ Tambah Education</button>
        </div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="tableEdu">
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Judul</th>
                <th>Detail</th>
                <th>Gambar</th>
                <th style="width:140px">Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: EMPLOYEES -->
  <dialog id="empModal">
    <form method="dialog" class="modal">
      <button type="button" class="modal-close" id="btnCloseEmp" aria-label="Tutup">Ã—</button>
      <h3 id="empModalTitle">Tambah Karyawan</h3>
      <div class="grid-2">
        <label>NID <input id="fNid" required></label>
        <label>Nama <input id="fName" required></label>
        <label>Jabatan <input id="fTitle" required></label>

        <label>Perusahaan
          <select id="fCompanySel" required>
            <option value="">Pilihâ€¦</option>
            <option>PT PLN</option>
            <option>PT PLN NP</option>
            <option>PT PLN NPS</option>
            <option>PT MKP</option>
            <option>PT MKP IC</option>
            <option>PENGAMANAN/SECURITY</option>
            <option>VISITOR</option>
            <option>PIHAK KE 3</option>
            <option value="OTHER">OTHER</option>
          </select>
        </label>
        <label id="wrapCompanyOther" class="hidden">Nama Perusahaan (Other)
          <input id="fCompanyOther" placeholder="Tulis nama perusahaanâ€¦">
        </label>

        <label>Shift
          <select id="fShift">
            <option value="A">Pagi (P)</option>
            <option value="B">Sore (S)</option>
            <option value="C">Malam (M)</option>
            <option value="DAYTIME">Day Time (DAY)</option>
          </select>
        </label>

        <label>Foto (URL) <input id="fPhoto" placeholder="https://â€¦ atau biarkan kosong"></label>
        <label>Foto (Upload) <input type="file" id="fPhotoFile" accept="image/*"></label>

        <div class="camera-actions" style="grid-column:1 / -1; justify-content:flex-end">
          <button type="button" class="btn" id="btnCamFront">ğŸ“¸ Kamera Depan</button>
          <button type="button" class="btn" id="btnCamBack">ğŸ“· Kamera Belakang</button>
          <small class="muted">Jika akses kamera ditolak/tidak tersedia, sistem akan menawarkan unggah file.</small>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" id="btnExitEmp" value="cancel" type="button">Keluar</button>
        <button class="btn primary" id="btnSaveEmp" value="default" type="button">Simpan</button>
      </div>
    </form>
  </dialog>

  <!-- MODAL: INFO -->
  <dialog id="newsModal">
    <form method="dialog" class="modal">
      <h3>Info Terbaru</h3>
      <div class="grid-2">
        <label>Judul <input id="nTitle" required></label>
        <label>Link (opsional) <input id="nLink" placeholder="https://â€¦"></label>
        <label style="grid-column:1 / -1">Isi
          <textarea id="nBody" rows="4" style="width:100%"></textarea>
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="btnBackNews" value="cancel">Kembali</button>
        <button class="btn primary" id="btnSaveNews" value="default">Simpan</button>
      </div>
    </form>
  </dialog>

  <!-- BARU: MODAL EDUCATION -->
  <dialog id="eduModal">
    <form method="dialog" class="modal">
      <button type="button" class="modal-close" id="btnCloseEdu" aria-label="Tutup">Ã—</button>
      <h3 id="eduModalTitle">Education</h3>
      <div class="grid-2">
        <label>Judul <input id="eTitle" required></label>
        <label>Upload Gambar (opsional) <input type="file" id="eImage" accept="image/*"></label>
        <label style="grid-column:1 / -1">Detail
          <textarea id="eBody" rows="4" style="width:100%" placeholder="Ringkasan materi / poin pembelajaran"></textarea>
        </label>
      </div>
      <div class="img-preview hidden" id="eImgWrap">
        <img id="ePreview" alt="Preview">
        <button type="button" class="btn ghost" id="btnClearImg">Hapus Gambar</button>
        <small class="muted">Gambar otomatis dikompresi untuk hemat penyimpanan.</small>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="btnBackEdu" value="cancel">Kembali</button>
        <button class="btn primary" id="btnSaveEdu" value="default">Simpan</button>
      </div>
    </form>
  </dialog>

  <!-- (opsional) elemen tersembunyi -->
  <canvas id="hiddenBarcode" width="560" height="180" class="hidden"></canvas>

  <!-- ===== Statistik Kehadiran Realtime (donut + tabel) ===== -->
  <script>
  (()=>{ 
    const EMP_KEYS=['SA_EMPLOYEES','employees','EMPLOYEES','mkp_employees','pd_employees'];
    const ATT_KEYS=['SA_ATTENDANCE','attendance','attend_logs','attendance_today','attend_today','absensi_today'];
    const getFirstLS=(keys)=>{for(const k of keys){try{const v=localStorage.getItem(k);if(v)return JSON.parse(v)}catch(e){}}return null};
    const todayISO=()=>{const d=new Date();const m=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');return `${d.getFullYear()}-${m}-${dd}`};
    const normEmployees=(arr)=>Array.isArray(arr)?arr.map(x=>({id:x.nid??x.id??x.NID??x.employee_id??x.employeeId??x.kode??'',name:x.name??x.nama??x.fullname??x.employee_name??'',company:x.company??x.perusahaan??x.org??x.dept??x.instansi??'UNKNOWN'})):[];
    const pickTs=(x)=>{const ts=x.ts??x.time??x.tanggal??x.datetime??x.date??x.created_at;return ts?new Date(ts):new Date()};
    const normAttendance=(arr)=>Array.isArray(arr)?arr.map(x=>{const nid=x.nid??x.employeeId??x.id??x.NID??x.kode??x.employee_nid??'';const type=(x.type??x.mode??x.status??x.scanType??x.event??x.ket??'').toString();const d=pickTs(x);const date=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;const company=x.company??x.perusahaan??x.org??x.dept??'';return {nid,type,company,date}}):[];
    const findCompanyByNid=(emps,nid)=>(emps.find(e=>e.id==nid)?.company)||'UNKNOWN';
    function collectPresence(){const rawEmps=window.employees||window.APP?.employees||getFirstLS(EMP_KEYS)||[];const rawAtts=window.attendance||window.APP?.attendance||getFirstLS(ATT_KEYS)||[];const employees=normEmployees(rawEmps);const atts=normAttendance(rawAtts).filter(a=>a.date===todayISO());const map=Object.create(null);for(const e of employees){const c=e.company||'UNKNOWN';(map[c]||={company:c,total:0,present:0,seen:new Set()}).total++}for(const a of atts){if(/in|datang|masuk/i.test(a.type)){const c=a.company||findCompanyByNid(employees,a.nid);(map[c]||={company:c,total:0,present:0,seen:new Set()});if(!map[c].seen.has(a.nid)){map[c].present++;map[c].seen.add(a.nid)}}}const rows=Object.values(map).map(o=>({company:o.company,total:o.total,present:o.present,percent:o.total?Math.round(o.present/o.total*100):0})).sort((a,b)=>(b.present-a.present)||a.company.localeCompare(b.company));return rows}
    let pie=null;
    function renderPresence(){
      const panel=document.getElementById('scan-stats'); if(!panel) return;
      const rows=collectPresence();
      const tbody=document.getElementById('presenceTBody');
      if(tbody){
        tbody.innerHTML=rows.map(r=>`<tr><td>${r.company}</td><td><b>${r.present}</b> / ${r.total}</td><td>${r.percent}%</td><td><div class="presence-bar"><i style="width:${r.percent}%"></i></div></td></tr>`).join('');
      }
      const t=document.getElementById('scan-stats-time'); if(t) t.textContent=new Date().toLocaleTimeString();
      const ctx=document.getElementById('presencePie');
      if(ctx&&window.Chart){
        const labels=rows.map(r=>r.company);
        const values=rows.map(r=>r.present);
        if(pie) pie.destroy();
        pie=new Chart(ctx,{type:'pie',data:{labels,datasets:[{data:values}]},options:{responsive:true,animation:false,plugins:{legend:{position:'bottom'}}}});
      }
    }
    document.addEventListener('DOMContentLoaded',()=>{
      renderPresence();
      setInterval(renderPresence,15000);
      window.addEventListener('scan:saved',renderPresence);
      window.addEventListener('attendance:changed',renderPresence);
      window.addEventListener('attendance:update',renderPresence);
      window.refreshScanStats=renderPresence;
    });
  })();
  </script>

  <!-- ===== Kalender Bulan Ini (month-view) ===== -->
  <script>
  (function(){
    const ATT_KEYS=['SA_ATTENDANCE','attendance','attend_logs','attendance_today','attend_today','absensi_today'];
    const getFirstLS=(keys)=>{for(const k of keys){try{const v=localStorage.getItem(k);if(v)return JSON.parse(v)}catch(e){}}return null};
    const pickTs=(x)=>{const ts=x.ts??x.time??x.tanggal??x.datetime??x.date??x.created_at;return ts?new Date(ts):new Date()};
    let calDate=new Date();
    function renderMonthCalendar(date=calDate){
      calDate=new Date(date);const host=document.getElementById('monthCalendar');if(!host)return;
      const y=calDate.getFullYear();const m=calDate.getMonth();const first=new Date(y,m,1);
      const daysInPrev=new Date(y,m,0).getDate();const daysInCur=new Date(y,m+1,0).getDate();
      const startIdx=(first.getDay()+6)%7;
      const rawAtt=window.attendance||window.APP?.attendance||getFirstLS(ATT_KEYS)||[];
      const attDays=new Set(rawAtt.filter(r=>{const d=pickTs(r);const st=(r.type||r.status||r.mode||r.event||'').toString();return d.getFullYear()===y&&d.getMonth()===m&&/in|datang|masuk/i.test(st)}).map(r=>pickTs(r).getDate()));
      const title=first.toLocaleDateString('id-ID',{month:'long',year:'numeric'});
      const dow=['Sen','Sel','Rab','Kam','Jum','Sab','Min'];
      let cells='';for(let i=startIdx;i>0;i--){const d=daysInPrev-i+1;cells+=`<div class="mc-day muted" aria-disabled="true">${d}</div>`}
      const today=new Date();for(let d=1;d<=daysInCur;d++){const isToday=(y===today.getFullYear()&&m===today.getMonth()&&d===today.getDate());const has=attDays.has(d);cells+=`<div class="mc-day ${isToday?'today':''} ${has?'has-logs':''}" data-day="${d}" tabindex="0"><span>${d}</span></div>`}
      const pad=42-(startIdx+daysInCur);for(let i=1;i<=pad;i++){cells+=`<div class="mc-day muted" aria-disabled="true">${i}</div>`}
      host.innerHTML=`<div class="mc-head"><div class="mc-title">${title}</div><div class="mc-nav"><button class="btn" id="mcPrev">â€¹</button><button class="btn ghost" id="mcToday">Hari ini</button><button class="btn" id="mcNext">â€º</button></div></div><div class="mc-dow">${dow.map(d=>`<div class="mc-d">${d}</div>`).join('')}</div><div class="mc-grid">${cells}</div>`;
      host.querySelector('#mcPrev')?.addEventListener('click',()=>renderMonthCalendar(new Date(y,m-1,1)));
      host.querySelector('#mcNext')?.addEventListener('click',()=>renderMonthCalendar(new Date(y,m+1,1)));
      host.querySelector('#mcToday')?.addEventListener('click',()=>renderMonthCalendar(new Date()));
    }
    function scheduleMidnightTick(){const now=new Date();const next=new Date(now);next.setHours(24,0,0,150);setTimeout(()=>{renderMonthCalendar(new Date());scheduleMidnightTick()},next-now)}
    document.addEventListener('DOMContentLoaded',()=>{renderMonthCalendar();scheduleMidnightTick();window.addEventListener('attendance:update',()=>renderMonthCalendar(calDate));window.addEventListener('attendance:changed',()=>renderMonthCalendar(calDate))});
  })();
  </script>

  <!-- Jam kecil untuk header statistik company -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const el=document.getElementById('companyLiveTime'); if(!el) return;
      const tick=()=> el.textContent=new Date().toLocaleTimeString();
      tick(); setInterval(tick,1000);
    });
  </script>

  <!-- DEDUPE judul statistik di Dashboard -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const root=document.getElementById('route-dashboard'); if(!root) return;
      const normalize=s=>(s||'').replace(/\s+/g,' ').trim().toLowerCase();
      const dedupe=()=>{const nodes=[...root.querySelectorAll('h1,h2,h3,.card-title,.card-title-light,b,strong,span,div')];let kept=false;nodes.forEach(el=>{const txt=normalize(el.textContent);if(txt.startsWith('statistik kehadiran')){if(!kept){kept=true}else{if(el.parentElement&&el.parentElement.children.length===1&&normalize(el.parentElement.textContent).startsWith('statistik kehadiran')){el.parentElement.remove()}else{el.remove()}}}})};
      dedupe(); new MutationObserver(dedupe).observe(root,{childList:true,subtree:true});
    });
  </script>

  <!-- BARU: LOGIKA EDUCATION -->
<script>
(()=> {
Â  const LS_KEY = 'SA_EDUCATION';
Â  const $ Â = (s,el=document)=>el.querySelector(s);
Â  const $$ = (s,el=document)=>[...el.querySelectorAll(s)];
Â  const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch { return []; } };
Â  const save = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));
Â  const fmt Â = (ts)=> new Date(ts).toLocaleString('id-ID');
Â  const makeId = ()=> 'e_'+Date.now().toString(36)+Math.random().toString(36).slice(2,7);
Â  const esc = (s)=> (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

Â  // [BARU] Fungsi untuk pull dan merge data dari Supabase
Â  async function pullAndMergeEducation() {
Â  Â  Â  if (!window.supabase) {
Â  Â  Â  Â  Â  console.warn('Supabase client not found, skipping pull for Education.');
Â  Â  Â  Â  Â  return load(); // Kembalikan data lokal saja
Â  Â  Â  }

Â  Â  Â  console.log('[Education] Pulling data from Supabase...');
Â  Â  Â  const { data: remoteData, error } = await window.supabase.from('education').select('*');
Â  Â  Â  
Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  console.warn('[Supabase Education Pull Error]', error);
Â  Â  Â  Â  Â  return load(); // Gagal pull, kembalikan data lokal
Â  Â  Â  }

Â  Â  Â  if (!remoteData) {
Â  Â  Â  Â  Â  return load(); // Tidak ada data, kembalikan data lokal
Â  Â  Â  }

Â  Â  Â  // --- Logika Merge (Penggabungan Data) ---
Â  Â  Â  const localData = load();
Â  Â  Â  // Buat 'Map' dari data lokal untuk cek duplikat (berdasarkan 'ts')
Â  Â  Â  const localMap = new Map(localData.map(item => [Number(item.ts), item]));
Â  Â  Â  let changed = false;

Â  Â  Â  // Loop data dari server
Â  Â  Â  for (const remoteItem of remoteData) {
Â  Â  Â  Â  Â  const ts = Number(remoteItem.ts);
Â  Â  Â  Â  Â  if (!localMap.has(ts)) {
Â  Â  Â  Â  Â  Â  Â  // Jika data server tidak ada di lokal, tambahkan
Â  Â  Â  Â  Â  Â  Â  // Kita perlu buat 'id' lokal (e_...) agar tombol Hapus/Edit tetap berfungsi
Â  Â  Â  Â  Â  Â  Â  const localId = 'e_' + ts + Math.random().toString(36).slice(2, 7);
Â  Â  Â  Â  Â  Â  Â  localMap.set(ts, { ...remoteItem, id: localId });
Â  Â  Â  Â  Â  Â  Â  changed = true;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // (Opsional: Anda bisa tambahkan logika 'last-write-wins' di sini jika perlu)
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  if (changed) {
Â  Â  Â  Â  Â  const mergedList = Array.from(localMap.values());
Â  Â  Â  Â  Â  save(mergedList); // Simpan hasil gabungan ke LocalStorage
Â  Â  Â  Â  Â  console.log('[Education] Merged remote data into local storage.');
Â  Â  Â  Â  Â  return mergedList;
Â  Â  Â  }

Â  Â  Â  return localData; // Tidak ada perubahan
Â  }

Â  function compressImage(file, maxW=1200, maxH=1200, quality=0.82){
Â  Â  return new Promise((resolve,reject)=>{
Â  Â  Â  const fr = new FileReader();
Â  Â  Â  fr.onload = ev => {
Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  img.onload = ()=>{
Â  Â  Â  Â  Â  let width = img.width, height = img.height;
Â  Â  Â  Â  Â  const scale = Math.min(maxW/width, maxH/height, 1);
Â  Â  Â  Â  Â  width = Math.round(width*scale);
Â  Â  Â  Â  Â  height = Math.round(height*scale);
Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  canvas.width = width; canvas.height = height;
Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  ctx.drawImage(img,0,0,width,height);
Â  Â  Â  Â  Â  try{ resolve(canvas.toDataURL('image/jpeg', quality)); }
Â  Â  Â  Â  Â  catch(err){ reject(err); }
Â  Â  Â  Â  };
Â  Â  Â  Â  img.onerror = reject;
Â  Â  Â  Â  img.src = ev.target.result;
Â  Â  Â  };
Â  Â  Â  fr.onerror = reject;
Â  Â  Â  fr.readAsDataURL(file);
Â  Â  });
Â  }

Â  let editingId = null;
Â  let currentImg = null;

Â  function renderEduTable(){
Â  Â  const tbody = document.querySelector('#tableEdu tbody'); if(!tbody) return;
Â  Â  const rows = load().sort((a,b)=>b.ts-a.ts);
Â  Â  tbody.innerHTML = rows.map(r => 
Â  Â  Â  `<tr data-id="${r.id}">
Â  Â  Â  Â  <td>${fmt(r.ts)}</td>
Â  Â  Â  Â  <td><b>${esc(r.title)}</b></td>
Â  Â  Â  Â  <td>${esc(r.body).replace(/\n/g,'<br>')}</td>
Â  Â  Â  Â  <td>${r.img ? `<img src="${r.img}" alt="img" class="edu-thumb" onclick="window.open(this.src,'_blank')">` : 'â€”'}</td>
Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  <button class="btn ghost btn-edu-edit">Edit</button>
Â  Â  Â  Â  Â  <button class="btn danger btn-edu-del">Hapus</button>
Â  Â  Â  Â  </td>
Â  Â  Â  </tr>`
Â  Â  ).join('');

Â  Â  document.querySelectorAll('.btn-edu-del').forEach(btn=>{
Â  Â  Â  btn.addEventListener('click', ()=>{
Â  Â  Â  Â  const id = btn.closest('tr')?.dataset.id; if(!id) return;
Â  Â  Â  Â  
Â  Â  Â  Â  // [UBAH] Modifikasi untuk Supabase delete
Â  Â  Â  Â  const list = load(); // <-- [BARU] Ambil list lengkap
Â  Â  Â  Â  const itemToDelete = list.find(x => x.id === id); // <-- [BARU] Cari itemnya
Â  Â  Â  Â  const tsToDelete = itemToDelete?.ts; // <-- [BARU] Ambil 'ts' untuk Supabase

Â  Â  Â  Â  // Lanjutkan menghapus dari lokal
Â  Â  Â  Â  const next = list.filter(x=>x.id!==id);
Â  Â  Â  Â  save(next); renderEduTable(); renderHighlights();
Â  Â  Â  Â  window.dispatchEvent(new CustomEvent('education:changed'));

Â  Â  Â  Â  // [BARU] Kirim perintah HAPUS ke Supabase
Â  Â  Â  Â  if (window.supabase && tsToDelete) {
Â  Â  Â  Â  Â  Â  window.supabase.from('education').delete().eq('ts', tsToDelete)
Â  Â  Â  Â  Â  Â  Â  Â  .then(({ error }) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('[Supabase Education Delete Error]', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Data lokal terhapus, tapi gagal sinkron ke server. Cek console.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('[Supabase Education] Data terhapus di server.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  // [SELESAI BARU]
Â  Â  Â  });
Â  Â  });
Â  Â  document.querySelectorAll('.btn-edu-edit').forEach(btn=>{
Â  Â  Â  btn.addEventListener('click', ()=>{
Â  Â  Â  Â  const id = btn.closest('tr')?.dataset.id; if(!id) return;
Â  Â  Â  Â  const item = load().find(x=>x.id===id); if(!item) return;
Â  Â  Â  Â  editingId = id;
Â  Â  Â  Â  currentImg = item.img || null;
Â  Â  Â  Â  document.querySelector('#eduModalTitle').textContent = 'Ubah Education';
Â  Â  Â  Â  document.querySelector('#eTitle').value = item.title || '';
Â  Â  Â  Â  document.querySelector('#eBody').value Â = item.body Â || '';
Â  Â  Â  Â  document.querySelector('#eImage').value = '';
Â  Â  Â  Â  updatePreview();
Â  Â  Â  Â  document.querySelector('#eduModal').showModal();
Â  Â  Â  });
Â  Â  });
Â  }

Â  function updatePreview(){
Â  Â  const wrap = document.querySelector('#eImgWrap'), img = document.querySelector('#ePreview');
Â  Â  if(!wrap || !img) return;
Â  Â  if(currentImg){ img.src=currentImg; wrap.classList.remove('hidden'); }
Â  Â  else { img.removeAttribute('src'); wrap.classList.add('hidden'); }
Â  }
Â  function resetForm(){
Â  Â  editingId=null; currentImg=null;
Â  Â  document.querySelector('#eduModalTitle').textContent='Tambah Education';
Â  Â  document.querySelector('#eTitle').value=''; 
Â  Â  document.querySelector('#eBody').value=''; 
Â  Â  document.querySelector('#eImage').value='';
Â  Â  updatePreview();
Â  }

Â  function recencyPercent(ts){
Â  Â  const days = Math.floor((Date.now()-ts)/86400000);
Â  Â  return Math.max(35, Math.min(95, 95 - days*6));
Â  }

Â  /* === Highlights renderer (gabungan) === */
Â  function renderHighlights(){
Â  Â  const hostStandalone = document.querySelector('#eduList');
Â  Â  const hostInRecent Â  = document.querySelector('#eduListRecent');
Â  Â  const rc Â  Â  Â  Â  Â  Â  = document.getElementById('recentCard');

Â  Â  const items = load().sort((a,b)=>b.ts-a.ts).slice(0,6);

Â  Â  const html = items.length
Â  Â  Â  ? items.map(it=>{
Â  Â  Â  Â  Â  const pct = recencyPercent(it.ts);
Â  Â  Â  Â  Â  const img = it.img || '';
Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="edu-item">
Â  Â  Â  Â  Â  Â  Â  <img class="thumb" src="${img}" alt="" onerror="this.style.display='none'">
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="t">${esc(it.title)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="d">${esc(it.body).replace(/\n/g,' ')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="edu-bar" style="--pct:${pct}%"><i></i></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="meta">${fmt(it.ts)}</div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  }).join('')
Â  Â  Â  : `<div class="muted">Belum ada data education.</div>`;

Â  Â  if (hostInRecent) hostInRecent.innerHTML = html;
Â  Â  if (hostStandalone) hostStandalone.innerHTML = html;
Â  Â  if (rc) rc.setAttribute('data-has-edu', items.length ? '1' : '0');
Â  }

Â  document.addEventListener('DOMContentLoaded', async ()=>{ // <-- [UBAH] Tambahkan async
Â  Â  document.querySelector('#btnAddEdu')?.addEventListener('click', ()=>{ resetForm(); document.querySelector('#eduModal').showModal(); });
Â  Â  document.querySelector('#btnBackEdu')?.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelector('#eduModal').close(); });
Â  Â  document.querySelector('#btnCloseEdu')?.addEventListener('click', ()=> document.querySelector('#eduModal').close());

Â  Â  document.querySelector('#eImage')?.addEventListener('change', async (e)=>{
Â  Â  Â  const f = e.target.files?.[0]; if(!f) return;
Â  Â  Â  try{ currentImg = await compressImage(f,1200,1200,0.82); updatePreview(); }
Â  Â  Â  catch{ alert('Gagal memproses gambar.'); }
Â  Â  });

Â  Â  document.querySelector('#btnClearImg')?.addEventListener('click', ()=>{ currentImg=null; updatePreview(); });

Â  Â  document.querySelector('#btnSaveEdu')?.addEventListener('click', (e)=>{
Â  Â  Â  e.preventDefault();
Â  Â  Â  const title = (document.querySelector('#eTitle').value||'').trim();
Â  Â  Â  const body Â = (document.querySelector('#eBody').value ||'').trim();
Â  Â  Â  if(!title){ document.querySelector('#eTitle').focus(); return; }

Â  Â  Â  // [UBAH] Modifikasi untuk Supabase push
Â  Â  Â  const list = load();
Â  Â  Â  let itemToPush; // <-- [BARU] Definisikan variabel untuk item
Â  Â  Â  
Â  Â  Â  if(editingId){
Â  Â  Â  Â  const i = list.findIndex(x=>x.id===editingId);
Â  Â  Â  Â  if(i>-1){ 
Â  Â  Â  Â  Â  // Pastikan 'ts' tidak berubah saat edit (karena ini Primary Key)
Â  Â  Â  Â  Â  const originalTs = list[i].ts;
Â  Â  Â  Â  Â  list[i] = {...list[i], title, body, img: currentImg, ts: originalTs}; 
Â  Â  Â  Â  Â  itemToPush = list[i]; // <-- [BARU] Ambil item yang di-edit
Â  Â  Â  Â  }
Â  Â  Â  }else{
Â  Â  Â  Â  // [BARU] Buat itemnya dulu, baru di-push ke list
Â  Â  Â  Â  itemToPush = { id: makeId(), ts: Date.now(), title, body, img: currentImg }; 
Â  Â  Â  Â  list.push(itemToPush);
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  try{ save(list); } // Simpan ke lokal dulu
Â  Â  Â  catch{ alert('Penyimpanan penuh. Hapus item lama atau kecilkan gambar.'); return; }

Â  Â  Â  // [BARU] Kirim (Upsert) data ke Supabase
Â  Â  Â  if (window.supabase && itemToPush) {
Â  Â  Â  Â  // Buat payload bersih (hanya kolom yang ada di database)
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  ts: itemToPush.ts,
Â  Â  Â  Â  Â  title: itemToPush.title,
Â  Â  Â  Â  Â  body: itemToPush.body,
Â  Â  Â  Â  Â  img: itemToPush.img || null
Â  Â  Â  Â  };

Â  Â  Â  Â  // Gunakan .then() agar tidak memblokir UI
Â  Â  Â  Â  window.supabase.from('education').upsert(payload, { onConflict: 'ts' })
Â  Â  Â  Â  Â  Â  .then(({ error }) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('[Supabase Education Upsert Error]', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Data lokal tersimpan, tapi gagal sinkron ke server. Cek console.');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('[Supabase Education] Data tersimpan ke server.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  // [SELESAI BARU]

Â  Â  Â  document.querySelector('#eduModal').close();
Â  Â  Â  renderEduTable(); renderHighlights();
Â  Â  Â  window.dispatchEvent(new CustomEvent('education:changed'));
Â  Â  });

Â  Â  // [UBAH] Tarik data dari Supabase & Lokal sebelum me-render
Â  Â  console.log('[Education] Initializing...');
Â  Â  await pullAndMergeEducation(); // Tunggu data di-merge
Â  Â  console.log('[Education] Ready.');

Â  Â  renderEduTable(); 
Â  Â  renderHighlights();
Â  Â  window.addEventListener('storage', (e)=>{ if(e.key===LS_KEY){ renderEduTable(); renderHighlights(); } });
Â  Â  window.addEventListener('education:changed', ()=>{ renderEduTable(); renderHighlights(); });
Â  });
})();
</script>

  <!-- App utama -->
  <script defer src="app.js"></script>

  <!-- ===== LOCK GUARD untuk logo panel (anti mengecil) ===== -->
  <script>
    (function(){
      function applyLock(el){
        if(!el) return;
        const root = getComputedStyle(document.documentElement);
        const v = root.getPropertyValue('--brand-size').trim();
        const size = parseInt(v) || 98;

        ['width','height','minWidth','minHeight'].forEach(p => el.style[p] = size + 'px');
        el.style.flex = '0 0 auto';
        el.style.borderRadius = '50%';

        const img = el.querySelector('img');
        if(img){
          img.removeAttribute('width');
          img.removeAttribute('height');
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'contain';
        }
      }

      function setup(id){
        const el = document.getElementById(id);
        if(!el) return;

        const relock = () => applyLock(el);

        ['DOMContentLoaded','load','resize','hashchange','popstate','visibilitychange']
          .forEach(evt => window.addEventListener(evt, relock));

        const mo = new MutationObserver(relock);
        mo.observe(el, { attributes:true, attributeFilter:['style','class'] });

        applyLock(el);
      }

      setup('brandLogoPanelDash');
      setup('brandLogoPanelScan');
    })();
  </script>

  <!-- Sinkron jumlah "(N terakhir hari ini)" -->
  <script>
    (function(){
      function getLocal(key, fallback=[]) {
        try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
        catch { return fallback; }
      }
      function startOfTodayMs(){
        const d=new Date(); d.setHours(0,0,0,0); return d.getTime();
      }
      function computeCount(){
        const att = (window.attendance && Array.isArray(window.attendance))
          ? window.attendance
          : getLocal('SA_ATTENDANCE', []);
        const sod = startOfTodayMs();
        const today = att.filter(a => Number(a.ts||0) >= sod);
        return Math.min(3, today.length);
      }
      function setHeader(){
        const c = computeCount();
        const count = document.getElementById('recentCount');
        if(count){ count.textContent = `(${c} terakhir hari ini)`; }
      }
      document.addEventListener('DOMContentLoaded', setHeader);
      window.addEventListener('attendance:update', setHeader);
      window.addEventListener('attendance:changed', setHeader);
      setInterval(setHeader, 15000);
    })();
  </script>

  <!-- ========= NEW: Download ID Card (A1) ========= -->
  <script>
  (function(){
    const hasJsPDF = !!(window.jspdf && window.jspdf.jsPDF);
    if(!hasJsPDF){ console.warn('jsPDF belum termuat'); }

    function loadImg(url){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=>resolve(img);
        img.onerror = reject;
        img.src = url;
      });
    }

    async function generateIdCardA1(emp){
      const { jsPDF } = window.jspdf;
      const W = 594, H = 841; // mm, A1 portrait
      const doc = new jsPDF({ unit:'mm', format:[W,H], orientation:'portrait' });

      // Try load background template (opsional)
      try{
        const bg = await loadImg('assets/idcard-a1-template.png');
        doc.addImage(bg, 'PNG', 0, 0, W, H);
      }catch(e){
        // fallback background sederhana
        doc.setFillColor(248,250,252);
        doc.rect(0,0,W,H,'F');
        doc.setDrawColor(230,236,246);
        doc.roundedRect(10,10,W-20,H-20,4,4,'S');
      }

      // Foto (opsional)
      if(emp.photo){
        try{
          const p = await loadImg(emp.photo);
          const pw=90, ph=110, py=170;
          doc.addImage(p, 'JPEG', (W-pw)/2, py, pw, ph);
        }catch{}
      }

      // Nama & detail
      doc.setTextColor(20,45,85);
      doc.setFont('helvetica','bold'); doc.setFontSize(42);
      doc.text(emp.name || '-', W/2, 320, {align:'center', maxWidth: W-60});
      doc.setFont('helvetica','normal'); doc.setFontSize(24);
      const lines = [
        `NID: ${emp.nid || '-'}`,
        `Jabatan: ${emp.title || '-'}`,
        `Perusahaan: ${emp.company || '-'}`,
        `Shift: ${emp.shift || '-'}`

      ];
      let y = 335;
      for(const ln of lines){ doc.text(ln, W/2, y, {align:'center'}); y += 11; }

      // Barcode di tengah
      try{
        const cvs = document.getElementById('hiddenBarcode');
        JsBarcode(cvs, String(emp.nid||''), {format:'CODE128', displayValue:false, margin:0, height:180, width:4});
        const data = cvs.toDataURL('image/png');
        const bw = 320, bh = 70, bx = (W-bw)/2, by = 390;
        doc.addImage(data, 'PNG', bx, by, bw, bh);
      }catch(e){ console.warn('Barcode gagal dibuat', e); }

      // Footer lokasi
      doc.setFont('helvetica','bold'); doc.setFontSize(36);
      doc.text('PLTU AMPANA', W/2, H-50, {align:'center'});

      const file = `IDCARD_${(emp.nid||emp.name||'KARYAWAN').toString().replace(/\s+/g,'_')}.pdf`;
      doc.save(file);
    }

    function extractEmpFromRow(tr){
      const td = tr.querySelectorAll('td');
      return {
        photo  : tr.querySelector('img')?.src || null,
        nid    : (td[1]?.textContent||'').trim(),
        name   : (td[2]?.textContent||'').trim(),
        title  : (td[3]?.textContent||'').trim(),
        company: (td[4]?.textContent||'').trim(),
        shift  : (td[5]?.textContent||'').trim()
      };
    }

    function ensureIdCardButtons(){
      const tbody = document.querySelector('#tableEmp tbody'); if(!tbody) return;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const actions = tr.querySelector('td:last-child'); if(!actions) return;
        if(actions.querySelector('.btn-idcard')) return;
        const btn = document.createElement('button');
        btn.className = 'btn light btn-idcard';
        btn.title = 'Unduh ID Card';
        btn.textContent = 'ğŸªª';
        actions.insertBefore(btn, actions.firstChild);
      });
    }

    // Delegasi klik tombol
    document.addEventListener('click', async (e)=>{
      const b = e.target.closest('.btn-idcard'); if(!b) return;
      const tr = b.closest('tr'); if(!tr) return;
      const emp = extractEmpFromRow(tr);
      await generateIdCardA1(emp);
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      ensureIdCardButtons();
      const tb = document.querySelector('#tableEmp tbody');
      if(tb){
        const mo = new MutationObserver(ensureIdCardButtons);
        mo.observe(tb, {childList:true, subtree:true});
      }
    });
  })();
  </script>

  <!-- ======== LOGOUT (Supabase signOut + hapus SA_AUTH) ======== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnLogout')?.addEventListener('click', async () => {
        if(confirm('Logout dari SmartAttend?')){
          try { await window.supabase?.auth?.signOut(); } catch {}
          try { localStorage.removeItem('SA_AUTH'); } catch {}
          location.replace('login.html');
        }
      });
    });
  </script>

  <!-- ====== ADDED: Reset Data Lokal (Developer) button & script ====== -->
  <button id="dev-reset-local" title="Reset semua data lokal SmartAttend (developer)">Reset Data Lokal (Developer)</button>
  <script>
    (function(){
      const BTN = document.getElementById('dev-reset-local');
      if(!BTN) return;
      BTN.addEventListener('click', ()=>{
        const ok = confirm(
          'Reset Data Lokal akan menghapus data lokal berikut:\n' +
          'SA_EMPLOYEES, SA_ATTENDANCE, SA_SHIFTS, SA_NEWS, SA_SHIFT_MONTHLY, SA_EDUCATION, SA_AUTH\n\n' +
          'Lanjutkan?'
        );
        if(!ok) return;
        try{
          const keys = ['SA_EMPLOYEES','SA_ATTENDANCE','SA_SHIFTS','SA_NEWS','SA_SHIFT_MONTHLY','SA_EDUCATION','SA_AUTH'];
          keys.forEach(k=>localStorage.removeItem(k));
          // also attempt common alternate keys (non destructive if absent)
          const alt = ['employees','attendance','shifts_cfg','shift_monthly','news','APP_EMPLOYEES'];
          alt.forEach(k=>localStorage.removeItem(k));
          alert('Data lokal berhasil dihapus. Halaman akan direfresh.');
          // dispatch events so UI listeners can react before reload (optional)
          try{ window.dispatchEvent(new Event('attendance:changed')); window.dispatchEvent(new Event('attendance:update')); window.dispatchEvent(new Event('education:changed')); }catch(e){}
          location.reload();
        }catch(err){
          alert('Gagal menghapus data lokal: ' + (err && err.message ? err.message : err));
        }
      });

      // optional: hide button on production by reading an env flag in localStorage
      try{
        const hide = localStorage.getItem('HIDE_DEV_RESET') === '1';
        if(hide){ BTN.style.display='none'; }
      }catch(e){}
    })();
  </script>

</body>
</html>
