<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dasbor Kehadiran Karyawan ‚Ä¢ SmartAttend</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css?v=3.1" />

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
    referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/translation.js"></script>
  <script src="config.local.js"></script>
  <script>
    if (!localStorage.getItem('SA_SESSION')) { window.location.href = 'login.html'; }
  </script>

  <!-- Helper style kecil (tidak bentrok) -->
  <style>
    #empModal .modal {
      position: relative
    }

    #empModal .modal-close {
      position: absolute;
      right: 10px;
      top: 8px;
      border: 0;
      background: transparent;
      font-size: 24px;
      line-height: 1;
      cursor: pointer
    }

    .camera-actions {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .hidden {
      display: none
    }

    .company-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px
    }

    .company-card {
      background: var(--panel, #fff);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04)
    }

    .company-card .name {
      font-weight: 600
    }

    .company-card .sub {
      color: #64748b;
      font-size: 12px;
      margin-top: 2px
    }

    .company-card .badge {
      font-weight: 800;
      font-size: 22px
    }

    #tableShiftTime input[type="time"] {
      width: 140px;
      max-width: 100%
    }

    @media (max-width:1100px) {
      #route-scan .scan-stats-grid {
        grid-template-columns: 1fr
      }
    }

    /* === EDUCATION UI (dasar) === */
    .img-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px
    }

    .img-preview img {
      width: 96px;
      height: 96px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #e5e7eb
    }

    .edu-thumb {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      cursor: pointer
    }

    #eduHighlightsCard .card-title {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .edu-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px
    }

    .edu-item {
      background: var(--surface, #fff);
      border: 1px solid var(--line, #e6eefc);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, .05);
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 12px
    }

    .edu-item .thumb {
      width: 72px;
      height: 72px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid var(--line, #e6eefc);
      background: #f3f4f6
    }

    .edu-item .t {
      font-weight: 700;
      line-height: 1.25;
      margin-bottom: 2px
    }

    .edu-item .d {
      color: #64748b;
      font-size: 13px;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      overflow: hidden;
    }

    .edu-item .meta {
      color: #94a3b8;
      font-size: 12px;
      margin-top: 6px
    }

    .edu-bar {
      position: relative;
      margin-top: 10px;
      height: 14px;
      border-radius: 999px;
      background: var(--line, #e6eefc);
      overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, .05)
    }

    .edu-bar i {
      display: block;
      height: 100%;
      width: var(--pct, 60%);
      border-radius: inherit;
      background: linear-gradient(90deg, var(--primary-500, #4a8cff), var(--primary-300, #a6c8ff))
    }

    .edu-bar .val {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      color: #0b2545
    }

    /* ===== BRAND CORNER (Logo kiri-atas untuk Dashboard & Scan) ===== */
    :root {
      --brand-size: 150px;
      /* 76‚Äì150px sesuai kebutuhan */
      --brand-gap: 12px;
    }

    #route-dashboard,
    #route-scan {
      position: relative;
    }

    .brand-corner {
      --panel-alpha: .55;
      /* opasitas panel logo */

      position: absolute;
      top: 12px;
      left: 12px;
      width: var(--brand-size);
      height: var(--brand-size);
      display: grid;
      place-items: center;
      padding: 10px;
      background: rgba(255, 255, 255, var(--panel-alpha));
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      z-index: 4;
      backdrop-filter: blur(6px);
    }

    .brand-corner img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    /* Geser konten agar tidak ketimpa logo - DIHAPUS karena logo sudah di header */
    /* #route-dashboard .greet {
      margin-left: calc(var(--brand-size) + var(--brand-gap));
    }

    #route-scan .scan-hero-left {
      margin-left: calc(var(--brand-size) + var(--brand-gap));
    } */

    /* Responsif */
    @media (max-width: 1100px) {
      .header-modern {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 12px;
        height: auto;
        gap: 12px;
      }

      .header-logo {
        position: relative;
        left: auto;
        top: auto;
        margin-bottom: 4px;
        /* Keep logo reasonably sized */
        width: 80px;
        height: 80px;
      }

      .brand-corner {
        --brand-size: 70px;
        top: 10px;
        left: 10px;
      }

      .header-content {
        margin-left: 0;
        margin-right: 0;
        max-width: 100%;
      }

      .header-title {
        font-size: 1.1rem;
        line-height: 1.3;
      }

      .header-subtitle {
        font-size: 0.85rem;
      }

      .header-right {
        position: relative;
        right: auto;
        top: auto;
        flex-direction: row;
        justify-content: center;
        margin-top: 4px;
      }

      .header-clock {
        font-size: 1.5rem;
      }
    }

    /* Tetap tampil saat fullscreen */
    #route-dashboard:fullscreen .brand-corner,
    #route-dashboard:-webkit-full-screen .brand-corner,
    #route-scan:fullscreen .brand-corner,
    #route-scan:-webkit-full-screen .brand-corner {
      position: absolute;
      top: 12px;
      left: 12px;
    }

    /* =========================
       PATCH: LOCK SIZE + HIDE % LABEL
       ========================= */
    .edu-bar .val {
      display: none !important;
    }

    /* sembunyikan label % */

    /* Kunci ukuran logo panel (dua lokasi) */
    #brandLogoPanelDash.brand-corner,
    #brandLogoPanelScan.brand-corner {
      inline-size: var(--brand-size) !important;
      block-size: var(--brand-size) !important;
      min-inline-size: var(--brand-size) !important;
      min-block-size: var(--brand-size) !important;
      aspect-ratio: 1 / 1;
      border-radius: 50% !important;
      /* buat bulat */
      flex: 0 0 auto !important;
    }

    #brandLogoPanelDash.brand-corner img,
    #brandLogoPanelScan.brand-corner img {
      inline-size: 100% !important;
      block-size: 100% !important;
      object-fit: contain !important;
    }

    /* ====== Layout gabungan: Recent + Education ====== */
    #recentCard .subhead {
      font-weight: 700;
      margin: 0 0 8px;
      color: var(--text)
    }

    #recentCard .recent-flex {
      display: grid;
      grid-template-columns: minmax(260px, 0.95fr) 1.05fr;
      /* kiri=Education, kanan=Tabel */
      gap: 12px;
      align-items: start;
      min-height: 0;
    }

    #recentCard .recent-edu {
      display: flex;
      flex-direction: column;
      min-height: 0
    }

    #recentCard .recent-table {
      min-width: 0
    }

    #recentCard .edu-list.compact {
      grid-template-columns: 1fr
    }

    #recentCard .edu-list.compact .edu-item {
      grid-template-columns: 56px 1fr;
      gap: 10px;
      padding: 10px;
      border-radius: 12px
    }

    #recentCard .edu-list.compact .thumb {
      width: 56px;
      height: 56px;
      border-radius: 10px
    }

    /* Jika Education kosong ‚Üí sembunyikan kolom kiri & tabel full */
    #recentCard[data-has-edu="0"] .recent-edu {
      display: none
    }

    #recentCard[data-has-edu="0"] .recent-table {
      grid-column: 1 / -1
    }

    /* Responsif */
    @media (max-width:1100px) {
      #recentCard .recent-flex {
        grid-template-columns: 1fr
      }

      #recentCard .recent-edu {
        order: 2
      }
    }

    /* =========================
       >> BARU: Animasi ‚Äúhidup‚Äù untuk Education (Highlights)
       ========================= */
    .edu-item {
      position: relative;
      will-change: transform, box-shadow;
      animation: eduPulse 3.4s ease-in-out infinite;
    }

    .edu-item::after {
      content: "";
      position: absolute;
      inset: -20% -10% auto -10%;
      height: 60%;
      background: radial-gradient(60% 50% at 20% 0%, rgba(255, 255, 255, .55), rgba(255, 255, 255, 0) 60%);
      pointer-events: none;
      animation: eduGlow 3.4s ease-in-out infinite;
    }

    .edu-item::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(130deg, transparent 5%, rgba(255, 255, 255, .55) 50%, transparent 95%);
      mix-blend-mode: screen;
      transform: translateX(-130%);
      animation: eduSweep 6s linear infinite;
      pointer-events: none;
    }

    .edu-item .thumb {
      animation: eduPing 2.6s ease-in-out infinite;
      transform-origin: center;
    }

    .edu-bar i {
      position: relative;
    }

    .edu-bar i::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-120%);
      background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, .65) 50%, transparent 100%);
      animation: eduBarShine 2.6s linear infinite;
    }

    @keyframes eduPulse {

      0%,
      100% {
        box-shadow: 0 8px 18px rgba(2, 6, 23, .08);
        transform: translateY(0)
      }

      50% {
        box-shadow: 0 14px 28px rgba(2, 6, 23, .16);
        transform: translateY(-2px)
      }
    }

    @keyframes eduGlow {

      0%,
      100% {
        opacity: .18;
        transform: translateY(0)
      }

      50% {
        opacity: .34;
        transform: translateY(-4px)
      }
    }

    @keyframes eduSweep {
      0% {
        transform: translateX(-130%)
      }

      100% {
        transform: translateX(130%)
      }
    }

    @keyframes eduPing {

      0%,
      100% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.04)
      }
    }

    @keyframes eduBarShine {
      0% {
        transform: translateX(-120%)
      }

      100% {
        transform: translateX(120%)
      }
    }

    @media (prefers-reduced-motion:reduce) {

      .edu-item,
      .edu-item::before,
      .edu-item::after,
      .edu-item .thumb,
      .edu-bar i::after {
        animation: none !important;
      }
    }
  </style>
</head>

<body>
  <!-- Mobile Sidebar Toggle -->
  <button id="btnMobileNav" class="mobile-nav-toggle" aria-label="Toggle Navigation">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay" class="sidebar-overlay"></div>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">‚óé</div>
      <div>
        <div class="brand-name">SmartAttend</div>
        <div class="brand-sub">PLTU AMPANA</div>
      </div>
    </div>

    <nav class="nav">
      <button class="navlink active" data-route="dashboard">üìä <span data-i18n="nav_dashboard">Dasbor</span></button>
      <button class="navlink" data-route="scan">üîé <span data-i18n="nav_scan">Scan Barcode</span></button>
      <button class="navlink" data-route="employees">üë• <span data-i18n="nav_employees">Database
          Karyawan</span></button>
      <button class="navlink" data-route="shifts">üïò <span data-i18n="nav_shifts">Shift Setting</span></button>
      <button class="navlink" data-route="attendance">üìë <span data-i18n="nav_report">Laporan 24 Jam</span></button>
      <button class="navlink" data-route="latest">üì∞ <span data-i18n="nav_latest">Latest information</span></button>
      <button class="navlink" data-route="education">üéì <span data-i18n="nav_education">Education</span></button>

      <hr style="border:0; border-top:1px solid var(--line); margin:8px 0;">

      <button class="navlink" id="btnLogout" style="color:var(--danger); font-weight:600;">
        üö™ <span data-i18n="nav_logout">Log Out</span>
      </button>
    </nav>

    <div class="sidebar-footer"><small data-i18n="footer_version">v1.4 ‚Ä¢ Local-first</small></div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <!-- DASHBOARD -->
    <section class="route" id="route-dashboard">
      <!-- MODERN HEADER (New) -->
      <div class="header-modern">
        <!-- Logo Kiri -->
        <div class="header-logo" id="brandLogoPanelDash">
          <img src="assets/LOGO PLN NP SERVICES - FIN.png" alt="PLN Nusantara Power Services"
            onerror="this.onerror=null; this.src='assets/LOGO PLN NP SERVICES - FIN.svg';">
        </div>

        <!-- Teks Tengah -->
        <div class="header-content">
          <h1 class="header-title" data-i18n="dash_welcome_title">SELAMAT DATANG DI PT PLN NUSANTARA POWER SERVICES
            LINGKUP PLTU AMPANA ‚ö°</h1>
          <div class="header-subtitle">
            <div class="marquee-wrap">
              <div class="marquee-content" data-i18n="dash_welcome_sub">ANDA BERADA DI KAWASAN PLN NPS UNIT PLTU AMPANA
                DAN
                WAJIB MEMATUHI SEMUA ATURAN YANG BERLAKU</div>
            </div>
          </div>
        </div>

        <!-- Kanan: Jam & Button -->
        <div class="header-right">
          <div class="header-clock" id="liveClock">--:--</div>
          <button id="btnFullDash" class="header-btn" data-i18n="btn_fullscreen">‚õ∂ Layar Penuh</button>
        </div>
      </div>

      <!-- Kartu statistik -->
      <!-- Kartu statistik (V2 Solid Color) -->
      <div class="grid-4">
        <!-- Blue: Total Karyawan -->
        <div class="card-solid stat-blue" data-hover-card="interactive"
          data-tooltip="Total semua karyawan yang terdaftar dalam database."
          onclick="$('.navlink[data-route=\'employees\']').click()">
          <div class="pills">
            <span class="pill" data-i18n="pill_today">Today</span>
            <span class="pill" data-i18n="pill_active">Active</span>
          </div>
          <div class="lbl" data-i18n="stat_total_emp">Total Karyawan</div>
          <div class="val" id="statTotalEmp">0</div>
        </div>

        <!-- Orange: Scan 24 Jam -->
        <div class="card-solid stat-orange" data-hover-card="interactive"
          data-tooltip="Jumlah aktivitas scan (masuk & pulang) dalam 24 jam terakhir."
          onclick="showStatDetail('scan24h')">
          <div class="pills">
            <span class="pill" data-i18n="pill_24h">24 Hours</span>
          </div>
          <div class="lbl" data-i18n="stat_scan_24h">Scan 24 jam</div>
          <div class="val" id="statScan24h">0</div>
        </div>

        <!-- Cyan: On-time -->
        <div class="card-solid stat-cyan" data-hover-card="interactive"
          data-tooltip="Karyawan yang melakukan scan MASUK tepat waktu hari ini." onclick="showStatDetail('ontime')">
          <div class="pills">
            <span class="pill">Daily</span>
          </div>
          <div class="lbl" data-i18n="stat_ontime">On-time</div>
          <div class="val" id="statOnTime">0</div>
        </div>

        <!-- Green: Terlambat -->
        <div class="card-solid stat-green" data-hover-card="interactive"
          data-tooltip="Karyawan yang terlambat melakukan scan MASUK hari ini." onclick="showStatDetail('late')">
          <div class="pills">
            <span class="pill">Alert</span>
          </div>
          <div class="lbl" data-i18n="stat_late">Terlambat</div>
          <div class="val" id="statLate">0</div>
        </div>
      </div>

      <!-- Hide Old Stats (Backup) -->
      <div class="grid-3 hidden">
        <div class="card stat">
          <div class="stat-sub"><span id="statShiftBreakdown">‚Äî</span></div>
        </div>
        <div class="card stat">
          <div class="stat-sub"><span data-i18n="stat_in">Datang</span>: <b id="statIn24h">0</b> ‚Ä¢ <span
              data-i18n="stat_out">Pulang</span>: <b id="statOut24h">0</b></div>
        </div>
      </div>

      <!-- Active Shift & Overtime Row -->
      <div style="display:flex; gap:16px; margin-bottom:20px; align-items:stretch;">

        <!-- Active Shift Panel -->
        <div class="card" style="flex:1; border-left:4px solid var(--primary-500)">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
            <h3 style="margin:0; font-size:1.1rem">üïí Shift Yang Sedang Bertugas</h3>
          </div>
          <div id="activeShiftsContainer" style="display:flex; flex-wrap:wrap; gap:8px;">
            <!-- Shift content rendered by JS -->
          </div>
        </div>

        <!-- Overtime Panel (Dashboard) -->
        <div id="overtimePanelDash" class="card" onclick="showOvertimeList()" title="Klik untuk melihat detail"
          style="display:none; width: auto; min-width: 200px; border-left:4px solid var(--danger-500); background: #fff0f0; cursor:pointer; align-items:center; justify-content:space-between; gap:16px;">
          <div>
            <h3 style="margin:0; font-size:1.1rem; color:var(--danger-700)">Overtime</h3>
            <div class="muted" style="font-size:0.85rem">Melewati jam pulang</div>
          </div>
          <div id="overtimeCountDash" style="font-size:2rem; font-weight:800; color:var(--danger-600)">0</div>
        </div>

      </div>

      <!-- Company Presence -->
      <div class="card" id="companyPresenceCard">
        <div class="card-title" data-i18n="company_attendance_title">Company Attendance (today)</div>
        <div class="live-row" style="margin:2px 0 10px">
          <b data-i18n="company_live_stats">STATISTIK KEHADIRAN LANGSUNG</b>
          <span class="muted" id="companyLiveTime">--:--:--</span>
        </div>
        <div id="companyPresenceGrid" class="company-grid"></div>
      </div>

      <!-- ===== DASH TRIO ===== -->
      <div class="dash-trio">
        <div class="card" id="monthCalendarCard" data-hover-card>
          <div class="card-title" data-i18n="card_monthly_calendar">Kalender Bulan Ini</div>
          <div id="monthCalendar"></div>
        </div>

        <div class="card" id="newsCardDash">
          <div class="card-title" data-i18n="card_latest_info">Informasi Terbaru‚ö†Ô∏èüì¢</div>
          <div class="news-grid" id="newsGridDash"></div>
        </div>

        <!-- GABUNG: Aktivitas Terbaru + Education (fleksibel) -->
        <div class="card" id="recentCard" data-has-edu="0">
          <div class="recent-flex">
            <!-- Education (Highlights) -->
            <aside class="recent-edu" id="recentEduPane">
              <div class="subhead">Education (Highlights)</div>
              <div id="eduListRecent" class="edu-list compact"></div>
            </aside>

            <!-- Tabel Aktivitas -->
            <div class="recent-table">
              <div class="subhead" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                  <span data-i18n="card_recent_activity">Aktivitas Terbaru</span>
                  <small id="recentCount" class="muted">(3 terakhir hari ini)</small>
                </div>
                <button onclick="exportExcel()" class="btn-export"
                  style="background:#28a745; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8rem;">
                  üìä Export Excel
                </button>
              </div>
              <div class="table-wrap">
                <table class="table" id="tableRecent">
                  <thead>
                    <tr>
                      <th data-i18n="table_time">Waktu</th>
                      <th data-i18n="table_status">Status</th>
                      <th data-i18n="table_nid">NID</th>
                      <th data-i18n="table_name">Nama</th>
                      <th data-i18n="table_shift">Shift</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- /GABUNG -->
      </div>

      <!-- (Kartu Education terpisah DIHAPUS) -->
    </section>

    <!-- SCAN -->
    <section class="route hidden" id="route-scan">
      <!-- MODERN HEADER (Scan Version) -->
      <div class="header-modern">
        <!-- Logo Kiri -->
        <div class="header-logo">
          <img src="assets/LOGO PLN NP SERVICES - FIN.png" alt="PLN Nusantara Power Services"
            onerror="this.onerror=null; this.src='assets/LOGO PLN NP SERVICES - FIN.svg';">
        </div>

        <!-- Teks Tengah -->
        <div class="header-content">
          <h1 class="header-title" data-i18n="scan_title_main">SELAMAT DATANG DI PT PLN NUSANTARA POWER SERVICES
            LINGKUP PLTU AMPANA ‚ö°</h1>
          <div class="header-subtitle">
            <div class="marquee-wrap">
              <div class="marquee-content" data-i18n="dash_welcome_sub">
                UTAMAKAN KESELAMATAN DAN KESEHATAN KERJA ‚Ä¢ PASTIKAN SUDAH SCAN PULANG SEBELUM MENINGGALKAN AREA
              </div>
            </div>
          </div>
        </div>

        <!-- Kanan: Jam & Button -->
        <div class="header-right">
          <div class="header-clock" id="liveClockScan">--:--</div>
          <button id="btnFull" class="header-btn" data-i18n="btn_fullscreen">‚õ∂ Layar Penuh</button>
        </div>
      </div>

      <!-- Stat Cards in Scan Page (Clone of Dashboard) -->
      <div class="grid-4" style="padding: 0 1rem; margin-top: 1rem;">
        <!-- Blue: Total Karyawan -->
        <div class="card-solid stat-blue" data-hover-card="interactive"
          data-tooltip="Total semua karyawan yang terdaftar dalam database."
          onclick="alert('Total Karyawan: ' + (employees?.length || 0))">
          <div class="pills">
            <span class="pill">Today</span>
            <span class="pill">Active</span>
          </div>
          <div class="lbl" data-i18n="stat_total_emp">Total Karyawan</div>
          <div class="val" id="statTotalEmpScan">0</div>
        </div>

        <!-- Orange: Scan 24 Jam -->
        <div class="card-solid stat-orange" data-hover-card="interactive"
          data-tooltip="Jumlah aktivitas scan (masuk & pulang) dalam 24 jam terakhir."
          onclick="showStatDetail('scan24h')">
          <div class="pills">
            <span class="pill">24 Hours</span>
          </div>
          <div class="lbl" data-i18n="stat_scan_24h">Scan 24 jam</div>
          <div class="val" id="statScan24hScan">0</div>
        </div>

        <!-- Cyan: On-time -->
        <div class="card-solid stat-cyan" data-hover-card="interactive"
          data-tooltip="Karyawan yang melakukan scan MASUK tepat waktu hari ini." onclick="showStatDetail('ontime')">
          <div class="pills">
            <span class="pill">Daily</span>
          </div>
          <div class="lbl" data-i18n="stat_ontime">On-time</div>
          <div class="val" id="statOnTimeScan">0</div>
        </div>

        <!-- Green: Terlambat -->
        <div class="card-solid stat-green" data-hover-card="interactive"
          data-tooltip="Karyawan yang terlambat melakukan scan MASUK hari ini." onclick="showStatDetail('late')">
          <div class="pills">
            <span class="pill">Alert</span>
          </div>
          <div class="lbl" data-i18n="stat_late">Terlambat</div>
          <div class="val" id="statLateScan">0</div>
        </div>
      </div>

      <div class="scan-ui">
        <div class="scan-hero">
          <!-- Kiri -->
          <div class="scan-hero-left">
            <div class="scan-hello"></div>
            <!-- Title Actions removed as it is now in header -->
            <!-- Input Scan -->
            <input id="scanInput" class="scan-input light" placeholder="Klik di sini lalu scan‚Ä¶" autocomplete="off"
              autocapitalize="off" spellcheck="false" inputmode="none" data-i18n="scan_placeholder" />
            <div class="hint light marquee-wrap" style="max-width: 600px;">
              <div class="marquee-content" data-i18n="scan_hint">Utamakan Keselamatan dan Kesehatan Kerja.</div>
            </div>

            <!-- Company Presence (Scan Version) -->
            <!-- Company Presence (Scan Version) -->
            <!-- Company Presence (Scan Version) -->
            <div class="card" id="companyPresenceCardScan"
              style="margin-top: 16px; border:none; box-shadow:none; padding:0;">
              <div class="live-row" style="margin:2px 0 16px">
                <b data-i18n="company_live_stats" style="font-size: 1.05rem;">STATISTIK KEHADIRAN LANGSUNG</b>
              </div>

              <div id="companyPresenceGridScan" class="company-grid"
                style="grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));"></div>
            </div>

            <!-- Shift & Overtime Panel Row -->
            <div class="row-panels" style="display:flex; gap:10px; margin-top:10px;">
              <!-- Shift Panel (Scan Version) -->
              <div id="activeShiftsScan" style="flex:1; display:flex; flex-wrap:wrap; gap:8px;"></div>

              <!-- Overtime Panel -->
              <div id="overtimePanelScan" class="card-light" onclick="showOvertimeList()"
                title="Klik untuk melihat detail"
                style="display:none; flex:0 1 auto; min-width:140px; border-color:var(--danger-200); background:var(--danger-50); padding: 8px 12px; align-items:center; justify-content:space-between; flex-direction:row; gap:12px; cursor:pointer; transition: background 0.2s;">
                <div>
                  <div class="card-title-light"
                    style="color:var(--danger-700); margin-bottom:2px; font-size: 0.95rem; font-weight:800;">Overtime
                  </div>
                  <div class="muted" style="font-size:0.8rem">Melewati jam pulang</div>
                </div>
                <div id="overtimeCount" style="font-size:1.5rem; font-weight:700; color:var(--danger-600)">0</div>
              </div>
            </div>

            <!-- STATISTIK KEHADIRAN (REALTIME) -->
            <!-- STATISTIK REMOVED -->

            <!-- Tabel 5 scan terbaru hari ini (MOVED HERE) -->
            <div class="scan-table card-light" style="margin-top:2px;">
              <div class="card-title-light" data-i18n="scan_history_title">Riwayat Scan (5 terbaru hari ini)</div>
              <div class="table-wrap light">
                <table class="table light" id="tableScan" style="font-size: 0.85rem;">
                  <thead>
                    <tr>
                      <th data-i18n="table_time">Waktu</th>
                      <th data-i18n="table_status">Status</th>
                      <th data-i18n="table_nid">NID</th>
                      <th data-i18n="table_name">Nama</th>
                      <th data-i18n="col_job">Jabatan</th>
                      <th data-i18n="scan_col_company">Perusahaan</th>
                      <th data-i18n="table_shift">Shift</th>
                      <th>Keterangan</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Kanan -->
          <div class="scan-hero-right" id="scanResult">
            <style>
              /* Local override for right panel scroll */
              #scanResult {
                overflow-y: auto;
                justify-content: flex-start;
              }
            </style>
            <!-- Wrapper Baru untuk Horizontal Layout -->
            <div class="scan-profile-card">
              <div class="photo-big" id="scanPhoto"></div>
              <div class="info">
                <div class="name" id="scanName">‚Äî</div>
                <div class="meta"><span id="scanNID">‚Äî</span> <span id="scanTitle">‚Äî</span></div>
                <div class="meta"><span id="scanCompany">‚Äî</span> <span id="scanShift">‚Äî</span></div>
                <div class="pill light" id="scanShiftCheck">‚Äî</div>
                <div class="ts" id="scanTs">‚Äî</div>
              </div>
            </div>

            <!-- Info terbaru (MOVED HERE) -->
            <div class="card-light" style="margin-top:24px; width:100%; text-align:left;">
              <div class="card-title-light">Informasi Terbaru ‚ö†Ô∏èüì¢</div>
              <div class="news-grid" id="newsGridScan"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- EMPLOYEES -->
    <section class="route hidden" id="route-employees">
      <div class="toolbar">
        <div class="left">
          <button id="btnAddEmp" class="btn primary" data-i18n="btn_add">Ôºã Tambah</button>
          <input type="file" id="fileImportEmp" accept=".xlsx,.xls" hidden>
          <button id="btnImportEmp" class="btn" data-i18n="btn_import">‚¨ÜÔ∏è Import Excel</button>
          <button id="btnExportEmp" class="btn ghost" data-i18n="btn_export">‚¨áÔ∏è Export Excel</button>
          <button id="btnTemplateEmp" class="btn ghost" data-i18n="btn_template">üìÑ Unduh Template</button>
        </div>
        <div class="right"><input id="searchEmp" class="search" placeholder="Cari nama atau NID‚Ä¶"
            data-i18n="search_placeholder" /></div>
      </div>

      <!-- Container untuk Kartu Perusahaan (Dynamic) -->
      <div id="employeeListContainer" class="company-stack">
        <!-- Content will be rendered by JS -->
      </div>

      <!-- HIDE OLD TABLE (for backup reference if needed, or remove) -->
      <div class="card hidden">
        <div class="table-wrap">
          <table class="table" id="tableEmp">
            <thead>
              <tr>
                <th data-i18n="col_photo">Foto</th>
                <th data-i18n="table_nid">NID</th>
                <th data-i18n="table_name">Nama</th>
                <th data-i18n="col_job">Jabatan</th>
                <th data-i18n="scan_col_company">Perusahaan</th>
                <th data-i18n="table_shift">Shift</th>
                <th data-i18n="table_action">Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SHIFTS -->
    <section class="route hidden" id="route-shifts">
      <div class="card">
        <div class="card-title" data-i18n="shift_title">Pengaturan Jam Shift</div>
        <div class="table-wrap">
          <table class="table" id="tableShiftTime">
            <thead>
              <tr>
                <th style="width:220px" data-i18n="shift_col_code">Kode</th>
                <th data-i18n="shift_col_in">Datang</th>
                <th data-i18n="shift_col_out">Pulang</th>
                <th style="width:120px" data-i18n="shift_col_action">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><select disabled>
                    <option>Pagi (P)</option>
                  </select></td>
                <td><input type="time" id="shiftPagiStart" value="08:00"></td>
                <td><input type="time" id="shiftPagiEnd" value="16:00"></td>
                <td></td>
              </tr>
              <tr>
                <td><select disabled>
                    <option>Sore (S)</option>
                  </select></td>
                <td><input type="time" id="shiftSoreStart" value="16:00"></td>
                <td><input type="time" id="shiftSoreEnd" value="24:00"></td>
                <td></td>
              </tr>
              <tr>
                <td><select disabled>
                    <option>Malam (M)</option>
                  </select></td>
                <td><input type="time" id="shiftMalamStart" value="24:00"></td>
                <td><input type="time" id="shiftMalamEnd" value="07:00"></td>
                <td></td>
              </tr>
              <!-- Shift D removed -->
              <tr>
                <td><select disabled>
                    <option>Day Time (DAY)</option>
                  </select></td>
                <td><input type="time" id="shiftDayStart" value="08:00"></td>
                <td><input type="time" id="shiftDayEnd" value="16:00"></td>
                <td></td>
              </tr>
              <tr>
                <td><select disabled>
                    <option>Libur (L)</option>
                  </select></td>
                <td><input type="time" disabled></td>
                <td><input type="time" disabled></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="toolbar">
          <button id="btnSaveShift" class="btn primary">üíæ Simpan Pengaturan</button>
          <span class="muted">Gunakan <b>24:00</b> untuk akhir hari. Sistem otomatis menangani lintas tengah
            malam.</span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Jadwal Shift Bulanan</div>
        <div class="toolbar" style="margin-bottom:8px">
          <div class="left" style="gap:10px; flex-wrap:wrap">
            <label>Bulan <input type="month" id="schedMonth" min="2022-01" max="2030-12"></label>
            <button class="btn" id="btnSchedDownload">üìÑ Download Template</button>
            <input type="file" id="fileImportSched" accept=".xlsx,.xls" hidden>
            <button class="btn" id="btnSchedImport">‚¨ÜÔ∏è Import Template</button>
          </div>
          <div class="right" style="gap:8px; display:flex">
            <button class="btn primary" id="btnSchedSave">üíæ Simpan Jadwal</button>
            <button class="btn ghost" id="btnSchedReset">üßπ Reset Bulan</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="table" id="tableSched"></table>
        </div>
        <small class="muted">Tips: pilih nama pada setiap sel. Data tersimpan per-bulan di perangkat ini.</small>
      </div>
    </section>

    <!-- ATTENDANCE -->
    <section class="route hidden" id="route-attendance">
      <!-- BARU: Panel Laporan Bulanan -->
      <div class="card" style="margin-bottom: 20px; border-left: 4px solid var(--primary-500);">
        <div class="card-title">üìä Laporan Efektifitas & Kinerja Bulanan</div>
        <div class="toolbar" style="margin-top:10px;">
          <div class="left" style="align-items: center; gap: 10px;">
            <label>Pilih Bulan: <input type="month" id="reportMonth"
                style="padding: 8px; border: 1px solid var(--line); border-radius: 8px;"></label>
            <button id="btnDownloadMonthlyReport" class="btn primary">‚¨áÔ∏è Download Laporan Kinerja (Excel)</button>
          </div>
        </div>
        <small class="muted">Laporan ini mencakup: Total Hadir, Total Terlambat, dan Hitungan Overtime per
          Karyawan.</small>
      </div>

      <div class="toolbar">
        <div class="left">
          <label>Dari <input type="date" id="attFrom"></label>
          <label>Sampai <input type="date" id="attTo"></label>
          <button id="btnFilterAtt" class="btn">üîç Tampilkan</button>

          <!-- Search Filter -->
          <input type="search" id="attSearch" placeholder="Cari Nama / NID..."
            style="padding: 8px 12px; border: 1px solid var(--line); border-radius: 8px; width: 200px;">

          <button id="btnExportAtt" class="btn ghost">‚¨áÔ∏è Export Excel</button>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="table table-elegant" id="tableAtt">
            <thead>
              <tr>
                <th style="padding-left:16px">WAKTU</th>
                <th>STATUS</th>
                <th>NID</th>
                <th>NAMA</th>
                <th>JABATAN</th>
                <th>PERUSAHAAN</th>
                <th>SHIFT</th>
                <th>KETERANGAN</th>
                <th style="text-align:right; padding-right:16px">AKSI</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- LATEST -->
    <section class="route hidden" id="route-latest">
      <div class="toolbar">
        <div class="left"><button id="btnAddNews" class="btn primary">Ôºã Tambah Info</button></div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table class="table-elegant" id="tableNews">
            <thead>
              <tr>
                <th>WAKTU</th>
                <th>JUDUL</th>
                <th>DETAIL</th>
                <th style="text-align:right; padding-right:16px">AKSI</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BARU: EDUCATION -->
    <section class="route hidden" id="route-education">
      <div class="toolbar">
        <div class="left">
          <button id="btnAddEdu" class="btn primary">Ôºã Tambah Education</button>
        </div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table class="table-elegant" id="tableEdu">
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Judul</th>
                <th>Detail</th>
                <th>Gambar</th>
                <th style="width:140px">Aksi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: EMPLOYEES -->
  <dialog id="empModal">
    <form method="dialog" class="modal">
      <button type="button" class="modal-close" id="btnCloseEmp" aria-label="Tutup">√ó</button>
      <h3 id="empModalTitle" data-i18n="modal_title_add_emp">Tambah Karyawan</h3>
      <div class="grid-2">
        <label><span data-i18n="modal_label_nid">NID</span> <input id="fNid" required></label>
        <label><span data-i18n="modal_label_name">Nama</span> <input id="fName" required></label>
        <label><span data-i18n="modal_label_job">Jabatan</span> <input id="fTitle" required></label>

        <label><span data-i18n="modal_label_company">Perusahaan</span>
          <select id="fCompanySel" required>
            <option value="">Pilih‚Ä¶</option>
            <option>PT PLN</option>
            <option>PT PLN NP</option>
            <option>PT PLN NPS</option>
            <option>PT MKP</option>
            <option>PT MKP IC</option>
            <option>PENGAMANAN/SECURITY</option>
            <option>VISITOR</option>
            <option>PIHAK KE 3</option>
            <option value="OTHER">OTHER</option>
          </select>
        </label>
        <label id="wrapCompanyOther" class="hidden"><span data-i18n="modal_label_other">Nama Perusahaan (Other)</span>
          <input id="fCompanyOther" placeholder="Tulis nama perusahaan‚Ä¶">
        </label>

        <label><span data-i18n="modal_label_shift">Shift</span>
          <select id="fShift">
            <option value="A">Pagi (P)</option>
            <option value="B">Sore (S)</option>
            <option value="C">Malam (M)</option>
            <option value="D">Shift D (D)</option>
            <option value="DAYTIME">Day Time (DAY)</option>
          </select>
        </label>

        <label><span data-i18n="modal_label_photo_url">Foto (URL)</span> <input id="fPhoto"
            placeholder="https://‚Ä¶ atau biarkan kosong"></label>
        <label><span data-i18n="modal_label_photo_upload">Foto (Upload)</span> <input type="file" id="fPhotoFile"
            accept="image/*"></label>

        <div class="camera-actions" style="grid-column:1 / -1; justify-content:flex-end">
          <button type="button" class="btn" id="btnCamFront"><span data-i18n="modal_btn_cam_front">üì∏ Kamera
              Depan</span></button>
          <button type="button" class="btn" id="btnCamBack"><span data-i18n="modal_btn_cam_back">üì∑ Kamera
              Belakang</span></button>
          <small class="muted" data-i18n="modal_cam_hint">Jika akses kamera ditolak/tidak tersedia, sistem akan
            menawarkan unggah file.</small>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" id="btnExitEmp" value="cancel" type="button"><span
            data-i18n="modal_btn_back">Keluar</span></button>
        <button class="btn primary" id="btnSaveEmp" value="default" type="button"><span
            data-i18n="modal_btn_save">Simpan</span></button>
      </div>
    </form>
  </dialog>

  <!-- MODAL: INFO -->
  <dialog id="newsModal">
    <form method="dialog" class="modal">
      <h3 data-i18n="modal_title_info">Info Terbaru</h3>
      <div class="grid-2">
        <label><span data-i18n="modal_label_title">Judul</span> <input id="nTitle" required></label>
        <label><span data-i18n="modal_label_link">Link (opsional)</span> <input id="nLink"
            placeholder="https://‚Ä¶"></label>
        <label style="grid-column:1 / -1"><span data-i18n="modal_label_body">Isi</span>
          <textarea id="nBody" rows="4" style="width:100%"></textarea>
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="btnBackNews" value="cancel"><span
            data-i18n="modal_btn_back">Kembali</span></button>
        <button class="btn primary" id="btnSaveNews" value="default"><span
            data-i18n="modal_btn_save">Simpan</span></button>
      </div>
    </form>
  </dialog>

  <!-- BARU: MODAL EDUCATION -->
  <dialog id="eduModal">
    <form method="dialog" class="modal">
      <button type="button" class="modal-close" id="btnCloseEdu" aria-label="Tutup">√ó</button>
      <h3 id="eduModalTitle" data-i18n="modal_title_edu">Education</h3>
      <div class="grid-2">
        <label><span data-i18n="modal_label_title">Judul</span> <input id="eTitle" required></label>
        <label><span data-i18n="modal_label_img">Upload Gambar (opsional)</span> <input type="file" id="eImage"
            accept="image/*"></label>
        <label style="grid-column:1 / -1"><span data-i18n="modal_label_body">Detail</span>
          <textarea id="eBody" rows="4" style="width:100%"
            placeholder="Ringkasan materi / poin pembelajaran"></textarea>
        </label>
      </div>
      <div class="img-preview hidden" id="eImgWrap">
        <img id="ePreview" alt="Preview">
        <button type="button" class="btn ghost" id="btnClearImg"><span data-i18n="modal_btn_remove_img">Hapus
            Gambar</span></button>
        <small class="muted">Gambar otomatis dikompresi untuk hemat penyimpanan.</small>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="btnBackEdu" value="cancel">Kembali</button>
        <button class="btn primary" id="btnSaveEdu" value="default">Simpan</button>
      </div>
    </form>
  </dialog>

  <!-- (opsional) elemen tersembunyi -->
  <canvas id="hiddenBarcode" width="560" height="180" class="hidden"></canvas>

  <!-- ===== Statistik Kehadiran Realtime (donut + tabel) ===== -->
  <script>
    (() => {
      const EMP_KEYS = ['SA_EMPLOYEES', 'employees', 'EMPLOYEES', 'mkp_employees', 'pd_employees'];
      const ATT_KEYS = ['SA_ATTENDANCE', 'attendance', 'attend_logs', 'attendance_today', 'attend_today', 'absensi_today'];
      const getFirstLS = (keys) => { for (const k of keys) { try { const v = localStorage.getItem(k); if (v) return JSON.parse(v) } catch (e) { } } return null };
      const todayISO = () => { const d = new Date(); const m = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); return `${d.getFullYear()}-${m}-${dd}` };
      const normEmployees = (arr) => Array.isArray(arr) ? arr.map(x => ({ id: x.nid ?? x.id ?? x.NID ?? x.employee_id ?? x.employeeId ?? x.kode ?? '', name: x.name ?? x.nama ?? x.fullname ?? x.employee_name ?? '', company: x.company ?? x.perusahaan ?? x.org ?? x.dept ?? x.instansi ?? 'UNKNOWN' })) : [];
      const pickTs = (x) => { const ts = x.ts ?? x.time ?? x.tanggal ?? x.datetime ?? x.date ?? x.created_at; return ts ? new Date(ts) : new Date() };
      const normAttendance = (arr) => Array.isArray(arr) ? arr.map(x => { const nid = x.nid ?? x.employeeId ?? x.id ?? x.NID ?? x.kode ?? x.employee_nid ?? ''; const type = (x.type ?? x.mode ?? x.status ?? x.scanType ?? x.event ?? x.ket ?? '').toString(); const d = pickTs(x); const date = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; const company = x.company ?? x.perusahaan ?? x.org ?? x.dept ?? ''; return { nid, type, company, date } }) : [];
      const findCompanyByNid = (emps, nid) => (emps.find(e => e.id == nid)?.company) || 'UNKNOWN';
      function collectPresence() { const rawEmps = window.employees || window.APP?.employees || getFirstLS(EMP_KEYS) || []; const rawAtts = window.attendance || window.APP?.attendance || getFirstLS(ATT_KEYS) || []; const employees = normEmployees(rawEmps); const atts = normAttendance(rawAtts).filter(a => a.date === todayISO()); const map = Object.create(null); for (const e of employees) { const c = e.company || 'UNKNOWN'; (map[c] ||= { company: c, total: 0, present: 0, seen: new Set() }).total++ } for (const a of atts) { if (/in|datang|masuk/i.test(a.type)) { const c = a.company || findCompanyByNid(employees, a.nid); (map[c] ||= { company: c, total: 0, present: 0, seen: new Set() }); if (!map[c].seen.has(a.nid)) { map[c].present++; map[c].seen.add(a.nid) } } } const rows = Object.values(map).map(o => ({ company: o.company, total: o.total, present: o.present, percent: o.total ? Math.round(o.present / o.total * 100) : 0 })).sort((a, b) => (b.present - a.present) || a.company.localeCompare(b.company)); return rows }
      let pie = null;
      function renderPresence() {
        const panel = document.getElementById('scan-stats'); if (!panel) return;
        const rows = collectPresence();
        const tbody = document.getElementById('presenceTBody');
        if (tbody) {
          tbody.innerHTML = rows.map(r => `<tr><td>${r.company}</td><td><b>${r.present}</b> / ${r.total}</td><td>${r.percent}%</td><td><div class="presence-bar"><i style="width:${r.percent}%"></i></div></td></tr>`).join('');
        }
        const t = document.getElementById('scan-stats-time'); if (t) t.textContent = new Date().toLocaleTimeString();
        const ctx = document.getElementById('presencePie');
        if (ctx && window.Chart) {
          const labels = rows.map(r => r.company);
          const values = rows.map(r => r.present);
          if (pie) pie.destroy();
          pie = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data: values }] }, options: { responsive: true, animation: false, plugins: { legend: { position: 'bottom' } } } });
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        renderPresence();
        setInterval(renderPresence, 15000);
        window.addEventListener('scan:saved', renderPresence);
        window.addEventListener('attendance:changed', renderPresence);
        window.addEventListener('attendance:update', renderPresence);
        window.refreshScanStats = renderPresence;
      });
    })();
  </script>

  <!-- ===== Kalender Bulan Ini (month-view) ===== -->
  <script>
    (function () {
      const ATT_KEYS = ['SA_ATTENDANCE', 'attendance', 'attend_logs', 'attendance_today', 'attend_today', 'absensi_today'];
      const getFirstLS = (keys) => { for (const k of keys) { try { const v = localStorage.getItem(k); if (v) return JSON.parse(v) } catch (e) { } } return null };
      const pickTs = (x) => { const ts = x.ts ?? x.time ?? x.tanggal ?? x.datetime ?? x.date ?? x.created_at; return ts ? new Date(ts) : new Date() };
      let calDate = new Date();
      function renderMonthCalendar(date = calDate) {
        calDate = new Date(date); const host = document.getElementById('monthCalendar'); if (!host) return;
        const y = calDate.getFullYear(); const m = calDate.getMonth(); const first = new Date(y, m, 1);
        const daysInPrev = new Date(y, m, 0).getDate(); const daysInCur = new Date(y, m + 1, 0).getDate();
        const startIdx = (first.getDay() + 6) % 7;
        const rawAtt = window.attendance || window.APP?.attendance || getFirstLS(ATT_KEYS) || [];
        const attDays = new Set(rawAtt.filter(r => { const d = pickTs(r); const st = (r.type || r.status || r.mode || r.event || '').toString(); return d.getFullYear() === y && d.getMonth() === m && /in|datang|masuk/i.test(st) }).map(r => pickTs(r).getDate()));
        const title = first.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
        const dow = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
        let cells = ''; for (let i = startIdx; i > 0; i--) { const d = daysInPrev - i + 1; cells += `<div class="mc-day muted" aria-disabled="true">${d}</div>` }
        const today = new Date(); for (let d = 1; d <= daysInCur; d++) { const isToday = (y === today.getFullYear() && m === today.getMonth() && d === today.getDate()); const has = attDays.has(d); cells += `<div class="mc-day ${isToday ? 'today' : ''} ${has ? 'has-logs' : ''}" data-day="${d}" tabindex="0"><span>${d}</span></div>` }
        const pad = 42 - (startIdx + daysInCur); for (let i = 1; i <= pad; i++) { cells += `<div class="mc-day muted" aria-disabled="true">${i}</div>` }
        host.innerHTML = `<div class="mc-head"><div class="mc-title">${title}</div><div class="mc-nav"><button class="btn" id="mcPrev">‚Äπ</button><button class="btn ghost" id="mcToday">Hari ini</button><button class="btn" id="mcNext">‚Ä∫</button></div></div><div class="mc-dow">${dow.map(d => `<div class="mc-d">${d}</div>`).join('')}</div><div class="mc-grid">${cells}</div>`;
        host.querySelector('#mcPrev')?.addEventListener('click', () => renderMonthCalendar(new Date(y, m - 1, 1)));
        host.querySelector('#mcNext')?.addEventListener('click', () => renderMonthCalendar(new Date(y, m + 1, 1)));
        host.querySelector('#mcToday')?.addEventListener('click', () => renderMonthCalendar(new Date()));
      }
      function scheduleMidnightTick() { const now = new Date(); const next = new Date(now); next.setHours(24, 0, 0, 150); setTimeout(() => { renderMonthCalendar(new Date()); scheduleMidnightTick() }, next - now) }
      document.addEventListener('DOMContentLoaded', () => { renderMonthCalendar(); scheduleMidnightTick(); window.addEventListener('attendance:update', () => renderMonthCalendar(calDate)); window.addEventListener('attendance:changed', () => renderMonthCalendar(calDate)) });
    })();
  </script>

  <!-- Jam kecil untuk header statistik company -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('companyLiveTime'); if (!el) return;
      const tick = () => el.textContent = new Date().toLocaleTimeString();
      tick(); setInterval(tick, 1000);
    });
  </script>

  <!-- DEDUPE judul statistik di Dashboard -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const root = document.getElementById('route-dashboard'); if (!root) return;
      const normalize = s => (s || '').replace(/\s+/g, ' ').trim().toLowerCase();
      const dedupe = () => { const nodes = [...root.querySelectorAll('h1,h2,h3,.card-title,.card-title-light,b,strong,span,div')]; let kept = false; nodes.forEach(el => { const txt = normalize(el.textContent); if (txt.startsWith('statistik kehadiran')) { if (!kept) { kept = true } else { if (el.parentElement && el.parentElement.children.length === 1 && normalize(el.parentElement.textContent).startsWith('statistik kehadiran')) { el.parentElement.remove() } else { el.remove() } } } }) };
      dedupe(); new MutationObserver(dedupe).observe(root, { childList: true, subtree: true });
    });
  </script>

  <!-- MODAL INFO / NEWS -->
  <dialog id="newsModal" class="modal">
    <div class="modal-head">
      <h3>Info / Pengumuman</h3>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>Judul</label>
        <input type="text" id="nTitle" class="input" placeholder="Contoh: Briefing Pagi">
      </div>
      <div class="field">
        <label>Isi Pesan</label>
        <textarea id="nBody" class="input" rows="3" placeholder="Deskripsi singkat..."></textarea>
      </div>
      <div class="field">
        <label>Link (Opsional)</label>
        <input type="text" id="nLink" class="input" placeholder="https://...">
      </div>
    </div>
    <div class="modal-actions">
      <button id="btnBackNews" class="btn ghost">Batal</button>
      <button id="btnSaveNews" class="btn primary">Simpan Info</button>
    </div>
  </dialog>

  <!-- App utama -->
  <!-- App utama (Removed duplicate) -->

  <!-- ===== LOCK GUARD untuk logo panel (anti mengecil) ===== -->
  <script>
    /* Legacy brand logo lock removed to allow CSS resizing */
    (function () { })();
  </script>

  <!-- >>> BARU: sinkron jumlah ‚Äú(N terakhir hari ini)‚Äù di header tabel recent <<< -->
  <script>
    (function () {
      function getLocal(key, fallback = []) {
        try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }
        catch { return fallback; }
      }
      function startOfTodayMs() {
        const d = new Date(); d.setHours(0, 0, 0, 0); return d.getTime();
      }
      function computeCount() {
        const att = (window.attendance && Array.isArray(window.attendance))
          ? window.attendance
          : getLocal('SA_ATTENDANCE', []);
        const sod = startOfTodayMs();
        const today = att.filter(a => Number(a.ts || 0) >= sod);
        return Math.min(3, today.length);
      }
      function setHeader() {
        const c = computeCount();
        const count = document.getElementById('recentCount');
        if (count) { count.textContent = `(${c} terakhir hari ini)`; }
      }
      document.addEventListener('DOMContentLoaded', setHeader);
      window.addEventListener('attendance:update', setHeader);
      window.addEventListener('attendance:changed', setHeader);
      setInterval(setHeader, 15000);
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="app.js"></script>
</body>

</html>